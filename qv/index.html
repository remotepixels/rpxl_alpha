<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="-1"/>
    <meta name="msapplication-TileColor" content="#2e2e2e"/>
    <meta name="description" content="Serverless web app that allows you transmit to a high quality stream to clients to view and comment on using WEBRTC and VDO.NINJA. Communication between clients is handled using low latency and very little bandwidth, dedicating as much bandwidth to the main strea, often the feed from an edit machine. Also, we think Capybara's are awesome though that might not be relevant in this case.">
    <meta name="keywords" content="Gui Felix, Advertising, Visual Effects, Motion Graphics, Remote Pixels, vdo.ninja"/>
    <meta name="robots" content="index, follow"/>
    <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

    <link rel="apple-touch-icon" sizes="180x180" href="../icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../icons/favicon-16x16.png">
    <link rel="mask-icon" href="../icons/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="../icons/favicon.ico">
    <meta name="color-scheme" content="light dark">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@200" rel="stylesheet" />

    <link rel="stylesheet" href="../styles/clientstyle.css">
    <link rel="stylesheet" href="../styles/styles.css">
    <link rel="stylesheet" href="../styles/mobilestyle.css">

    <title>alpha.rpxl.app v3 | Quickview</title>
</head>
<style>
    .mainZoom {
        left: 0px;
        top: 0px;
        height: calc(100% - 50px);
        width:100%;
        /* z-index:5; */
    }
    .viewersiframe{
        z-index:0;
    }
</style>
<body id="body">
    <!--iframes for vdo ninja and annotations canvas-->
    <div id="viewerMobile" class="hidden">
        <iframe class="viewersiframe hidden" id="viewersStream" allow="autoplay;camera;microphone;fullscreen;picture-in-picture;display-capture;midi;geolocation;screen-wake-lock;"></iframe>
    </div>

    <div class="mainZoom hidden" id="zoomdiv">
        <iframe class="mainstreamiframe" id="mainStream" allow="autoplay;screen-wake-lock;display-capture;"></iframe>   
        <canvas id="annotationsCanvas" class="annotationsCanvas"></canvas>
    </div>

    <!--Main interface-->
    <div id="mainWindow" class="hidden">
        <!--bottom menu bar-->
        <div id="bottomMenu" class="toolbar bottom">
            <div class="toolset" style="width:200px; outline: 0px;">
                <button class="tool toolmoresettings hidden" id="toolSettings" aria-expanded="false" role="button"><span class="material-symbols-outlined">settings</span></button>
            </div>
            <div class="toolspacer"></div>
            <div class="toolset" id="toolAnnotations">
                <button class="tool streamtool disable" aria-expanded="false" id="toolDraw" disabled role="button"><span class="material-symbols-outlined">format_ink_highlighter</span></button>
                <button class="tool streamtool toolmoresettings disable" aria-expanded="false" id="toolPalette" disabled role="button"><span class="material-symbols-outlined">palette</span></button>
                <button class="tool streamtool disable" aria-expanded="false" id="toolEraser" disabled role="button"><span class="material-symbols-outlined">ink_eraser_off</span></button>
            </div>
            <div class="toolspacer"></div>
            <div class="toolset"><button class="tool streamtool disable" aria-expanded="false" id="toolMuteStream" disabled role="button"><span class="material-symbols-outlined">volume_up</span></button>   
                <span class="volume streamtool" role="button"><input type="range" id="toolStreamVolume" value="80" min="0" max="100" disabled class="streamtool disable"></span>        
            </div>
        </div>
    </div>

    <div class="popupBG hidden" id="popupBG"></div>

    <dialog id="settingsDialog" class="toolpopup top middle hidden">
        <div class="table">
            <div id="camPreview" style="grid-column: 1 / span 2;" style="display:none;">
                <video id="camera" class="camera hidden" autoplay playsinline poster=""  style="display:none;"></video>
                <span id="meterGraph" class="meterGraph hidden"><span id="micmeter" class="meter"  style="display:none;"></span></span>
            </div>
            <div><span class="material-symbols-outlined" style="justify-content: center; align-items: center;">account_circle</span></div>
            <div><input type="text" maxlength="25" class="textinput" id="name" value="Quickviewer" contenteditable="true" autocomplete="off"></div>
            <div class="custom-select hidden"><select id="microphoneSource"><option value="">None</option></select></div>
            <div class="custom-select hidden"><select id="cameraSource"><option value="">None</option></select></div>
            <div></div><div></div>
            <div style="grid-column: 1 / span 2;"><button id="checkLogin" class="botton buttonblue buttonWider">Change settings</button></div>
        </div>
        <!-- duplicate elements not used (so use same logic in stream and client) -->
        <div class="hidden">Video source</div><div class="custom-select hidden"><select contenteditable="true" id="videoSource"><option value="">None</option></select></div>
        <div class="hidden">Audio source</div><div class="custom-select hidden"><select contenteditable="true" id="audioSource"><option value="">None</option></select> </div>
        <div style="grid-column: 1 / span 2 hidden" id="settingsDialogVideoAudioPreview"><video id="video" class="videosource hidden" autoplay playsinline poster="" muted></video><span id="meterGraph" class="meterGraph hidden"><span id="audiometer" class="meter hiddden"></span></div> 
    </dialog>

    <!----- popup color menu ------>
    <dialog id="paletteDialog" class="toolpopup bottom middle hidden " style="margin-right:auto;">
            <div>
                <span class="colorpot" role="button" value="black" aria-expanded="false" style="background-color: black;"></span>
                <span class="colorpot selectedcolorpot" role="button" value="white" aria-expanded="true" style="background-color: white;"></span>
                <span class="colorpot" role="button" value="cyan" aria-expanded="false" style="background-color: cyan;"></span>
                <span class="colorpot" role="button" value="magenta" aria-expanded="false" style="background-color: magenta;"></span>
                <span class="colorpot" role="button" value="yellow" aria-expanded="false" style="background-color: yellow;"></span>
            </div>
    </dialog>

    <!----- popup menu microphone mute ------>
    <dialog id="popupStreamMuted" class="centerhorizontal hidden notification">
        <h2>Incoming stream muted (You will still hear participants)</h2>
    </dialog>

</body>
</html>

<!--user microphone and camera selection and display-->
<!-- <script src="/scripts/deviceselect.js"></script> -->
<script src="/scripts/cookies.js"></script>
<script src="/scripts/initui.js"></script>
<script src="/scripts/initvdo.js"></script>
<script src="/scripts/interface.js"></script>
<script src="/scripts/annotations.js"></script>

<script lang="javascript">
randomBG (); //initui.js

localStorage.clear(); //clear local storage on load to avoid issues with old settings
sessionStorage.clear(); //clear session storage on load to avoid issues with old settings

checkSessionURL ()
//checks if an url parameter supplied, if valid, shows the client login dialog
function checkSessionURL () {
    const queryURL = window.location.search.slice(1);
    if (!queryURL) {       
        alert("Invalid Session ID provided in URL.\n\nIf you are seeing this the link supplied has been corrupted or is incomplete.\n\nPlease check with the streamer.");
        //window.location.href = "https://alpha.rpxl.app";
        return;
    };

    let decodeURL;

    try {
        decodeURL = window.atob(queryURL); 
            // Throws DOMException if invalid characters
        } catch (error) {
        if ((error instanceof URIError) || (error instanceof DOMException && error.message.includes("invalid character")) || (error instanceof TypeError)) {
            alert("Invalid Session ID provided in URL.\n\nIf you are seeing this the link supplied has been corrupted or is incomplete.\n\nPlease check with the streamer.");
            //window.location.href = "https://alpha.rpxl.app";
            return;
        } else {
            console.error("Unexpected error:", error);
            return;
        }
    }

    const params = new URLSearchParams(decodeURL);
    if (params.has('SID')) {
        const SID = params.get('SID');
        const sanitizedSessionID = encodeURIComponent(SID); 
        
        if (!sanitizedSessionID || sanitizedSessionID.length !== 9) {
            alert("Invalid Session ID provided in URL.\n\nIf you are seeing this the link supplied has been corrupted or is incomplete.\n\nPlease check with the streamer.");
            //window.location.href = "https://alpha.rpxl.app";
            return;
        } else {
            sessionStorage.setItem("sessionID", sanitizedSessionID);    //store the sanitized session ID for later
            sessionStorage.setItem("username", "Quickview")
            sessionStorage.setItem("camerDevice", "0");
            sessionStorage.setItem("microphoneDevice", "0");

            document.body.style.backgroundImage = "none";
            mainWindow.classList.remove("hidden");

            viewerStream(); //from initvdo.js
            setTimeout(function(){   
                viewMainStream();//from initvdo.js
            },250);
        }

    // checkCookie("username", "camera", "mic"); //cookies.js

    
    }
}      
</script>
