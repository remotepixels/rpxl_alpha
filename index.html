<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="-1"/>
    <meta name="msapplication-TileColor" content="#2e2e2e"/>
    <meta name="description" content="Serverless web app that allows you transmit to a high quality stream to clients to view and comment on using WEBRTC and VDO.NINJA. Communication between clients is handled using low latency and very little bandwidth, dedicating as much bandwidth to the main strea, often the feed from an edit machine. Also, we think Capybara's are awesome though that might not be relevant in this case.">
    <meta name="keywords" content="Gui Felix, Advertising, Visual Effects, Motion Graphics, Remote Pixels, vdo.ninja"/>
    <meta name="robots" content="index, follow"/>
    <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="icons/favicon.ico">
    <meta name="color-scheme" content="light dark">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@200" rel="stylesheet">

    <link rel="stylesheet" href="styles/clientstyle.css">
    <link rel="stylesheet" href="styles/styles.css">
    <link rel="stylesheet" href="styles/mobilestyle.css">

    <title>alpha.rpxl.app v3</title>
</head>

<body id="body">
        
    <div id="shmeg" class="shmeg">
        <div class="toolbar">
            <div class="toolspacer"></div>           
            <div class="toolset">
                <button class="tool toolblue" id="toolJoinSession" aria-expanded="false" style="width:250px;"><span>Join a live session</span></button>
            </div>
        </div>
        <div class="siteHeader">
            <img src="icons/android-chrome-192x192.png" class="siteMainIcon"/>
            <div class="siteTitle">RPXL</div>
            <p></p>
            <div class="siteSubTitle">Simple,<br>secure,<br>server less,<br>remote collaboration.</div>
        </div>

        <div class="textBackground">
            <div class="text">
                <p>&nbsp;</p>
                <h4>Stream high quality video from anywhere, to anywhere using only your browser.<sup>*</sup></h4>
                <p></p>
                Using the incredible open source <a href="https://vdo.ninja">vdo.ninja</a> software created by <a href="https://github.com/steveseguin/vdo.ninja">Steve Seguin</a>, RPXL is an optimised and simplified front end focused for realtime, remote editorial approvals.
                <p></p>
                Created as an alternative to server based messaging apps, vdo.ninja uses a peer to peer model allowing very low latency (less than 1 second) using webRTC and modern video codecs (vp9, Av1).
                <p></p>
                Bandwidth is concentrated on one, high quality primary video stream, for your edit. With only minimal data used for communication between participants (typically between 30kbps to 60kbps per participant), RPXL puts your work front and centre.
                <p>&nbsp;</p>
                <h4>No sign-ups, no downloads, <br>no watermarks, no time limits.<sup>**</sup></h4>
                <p></p>
                <img src="images/interface.jpg" width="800" height="483" style="border-radius: 5px; overflow: hidden; position: relative; display: inline-block;">
                <p> </p>
                As this app is essentially server-less there are no costs in running this service. 
                <p></p>
                So want to stream your timeline for to a remote client for quick feedback and approval? Go ahead.
                <p></p>
                Clients can annotate, zoom in on the stream to see details and give their feedback live, all with less than 2 seconds of delay from your edit timeline.
                <p>&nbsp;</p>
                <h4>So what's the catch? Is it secure?</h4>
                <p></p>
                <div class="table">
                    <div>Unlike Zoom or Teams all connections and encoding is handled by you. This means the more clients connect, the greater the load on your machine, typically about a dozen clients should be fine. The streaming can be offloaded to a separate machine if you want to keep your edit machine free of encoding duties.
                        <p></p>
                        The upside is all connections are direct, one to one and are not routed through a central server for distribution. Which means we don't see your data, we don't record your data and we don't use your data to train AI or whatever the hip young kids are doing these days.
                        <p></p>
                        WebRTC was designed to be secure from the start and as such all transfers are encrypted using DTLS (Datagram Transport Layer Security) and SRTP (Secure Real-time Transport Protocol). Added to HTTPS encryption this guarantees any communication between you and your clients, remains safe and secure.
                        <p></p>
                        STUN (Session Traversal Utilities for NAT) servers help devices behind NAT (Network Address Translation) determine their public IP address and port. This process facilitates peer-to-peer connections, even when devices are located in different network environments.
                        <p></p>
                        All this is handled invisibly and securely behind the scenes, this means your data is encrypted and stays encrypted. Once you disconnect all connections are closed and the session is terminated.
                        <p>&nbsp;</p>
                    </div>
                    <div><img src="images/secure.jpg" width="300" height="520" style="border-radius: 5px; overflow: hidden; position:relative; top:-100px;"></div>
                </div>
                <h4>Gotcha's. They're not that bad... really</h4>
                <p></p>
                In order to capture your video stream from your edit package you will either need a capture device (a cheap HDMI to USB capture device is fine) Blackmagic and AJA cards are not supported but the Blackmagic Web-presenter will work. An alternative is to use a virtual camera software such as OBS or NDI tools, they're free and they work very well. 
                <p></p>
                We've had some issues with the colour fidelity with some of the cheaper capture cards, it appears they sometimes double up the LUT on footage, this can cause some pretty big colour disparities ao be sure to test first.
                <p></p>
                This project is often updated and may be prone to breaking, we will try to minimize disruptions as best we can as we add features and fix things but your mileage may vary.
                <p></p>
                If you've read this far and still want to give it a go, use the button bellow to get started.
                <p>&nbsp;</p>
                <p></p>
                <a href="https://alpha.rpxl.app/stream" target="_self" style="text-decoration: none"><button class="botton buttonblue buttonWider">Create a live session</button></a>
                <p>&nbsp;</p>
                <hr>
                <p>&nbsp;</p>
                <h5>
                <sup>*</sup>Okay, you are going need some sort of capture device, or use NDI tools to get your video into your browser.<br>
                <sup>**</sup>Because we're awesome that way.
                </h5>
                <p>&nbsp;</p>
            </div>
        </div>
        <div class="footer">
            <div class="text">
                <p>&nbsp;</p>
                Links 
                <p></p>
                <a href="https://alpha.rpxl.app/stream/help.html">Creating a stream</a>
                <p></p>
                <a href="https://vdo.ninja">vdo.ninja website</a><br>
                <a href="https://https://docs.vdo.ninja">vdo.ninja documentation</a><br>
                <a href="https://github.com/steveseguin/vdo.ninja">vdo.ninja github</a>
                <p></p>
                <a href="https://discord.com/invite/T4xpQVv">Steve Seguin discord</a>	
                <p></p>
                <a href="https://ndi.video/tools/">ndi tools</a><br>
                <a href="https://obsproject.com">obs studio</a><br>
                <p style="text-align: right;">
                    <a href="#top">back to top</a>
                </p>
                <p>&nbsp;</p>
            </div>

        </div>
    </div>


    <!--iframes for vdo ninja and annotations canvas-->
    <iframe class="viewersiframe hidden" id="viewersStream" allow="autoplay;screen-wake-lock;camera *;microphone *;display-capture;"></iframe>
    <div class="mainZoom hidden" id="zoomdiv">
        <iframe class="mainstreamiframe" id="mainStream" allow="autoplay;screen-wake-lock;display-capture;"></iframe>   
        <canvas id="annotationsCanvas" class="annotationsCanvas"></canvas>
    </div>

    <!--Main interface-->
    <div id="mainWindow" class="hidden">
        <!--top menu bar-->
        <div id="topmenu" class="toolbar top">	
            <div style="width:20px"></div>
            <h3 id="sessionTitle">RPXL</h3>
            <div class="toolspacer"></div>           
            <div class="toolset">
                <a href="https://vdo.ninja" target="_blank" style="text-decoration: none">
                    <button class="botton buttonblue buttonWider" id="vdoninja">Powered by vdo.ninja</button>
                </a>
            </div>
        </div>
        <!--bottom menu bar-->
        <div id="bottomMenu" class="toolbar bottom">
            <div class="toolset">
                <button class="tool toolmoresettings" id="toolSettings" aria-expanded="false"><span class="material-symbols-outlined">settings</span></button>
            </div>
            <div class="toolset toolspacer">
                <button class="tool toolred disable" aria-expanded="false" id="toolMuteMicrophone"><span class="material-symbols-outlined">mic</span></button>
                <button class="tool disable" aria-expanded="false" id="toolMuteCamera" disabled><span class="material-symbols-outlined">photo_camera</span></button>
            </div>
            <div class="toolset" id="toolAnnotations">
                <button class="tool streamtool disable" aria-expanded="false" id="toolDraw" disabled><span class="material-symbols-outlined">format_ink_highlighter</span></button>
                <button class="tool streamtool toolmoresettings disable" aria-expanded="false" id="toolPalette" disabled><span class="material-symbols-outlined">palette</span></button>
                <button class="tool streamtool disable" aria-expanded="false" id="toolEraser" disabled><span class="material-symbols-outlined">ink_eraser_off</span></button>
            </div>
            <div class="toolspacer"></div>
            <div class="toolset"><button class="tool streamtool disable" aria-expanded="false" id="toolMuteStream" disabled><span class="material-symbols-outlined">volume_up</span></button>   
                <span class="volume streamtool"><input type="range" id="toolStreamVolume" value="80" min="0" max="100" disabled class="streamtool disable"></span>        
            </div>
        </div>
    </div>

    <div class="popupBG hidden" id="popupBG"></div>

    <!--enter session ID dialog-->
    <dialog open id="sessionDialog" class="toolpopup top middle hidden">
        <div class="dialogContent">
            <div><h2>Enter a valid Session ID to continue</h2></div>
            <div><input type="text" maxlength="6" class="sessionID" id="sessionID" contenteditable="true" oninput="restrictInput(event)" style="text-transform:uppercase" autofocus autocomplete="off"></div>
            <div><h3>6 character code supplied by the host</h3></div>
            <div><button id="checkSession" class="botton buttonblue buttonWider">Continue</button></div>
        </div>
    </dialog>

    <!--enter username, select camera and microphone dialog-->
    <dialog id="settingsDialog" class="toolpopup top middle hidden">
        <div class="table">
            <div id="camPreview" style="grid-column: 1 / span 2;">
                <video id="camera" class="camera " autoplay playsinline poster=""></video>
                <span id="meterGraph" class="meterGraph"><span id="micmeter" class="meter"></span></span>
            </div>
            <div>Name</div><div><input type="text" maxlength="25" class="textinput" id="name" placeholder="(Required)" contenteditable="true" autocomplete="off"></div>
            <div>Camera</div><div class="custom-select"><select contenteditable="true" id="cameraSource"><option value="">None</option></select></div>
            <div>Microphone</div><div class="custom-select"><select contenteditable="true" id="microphoneSource"><option value="" selected disabled>None</option></select></div>
            <div style="grid-column: 1 / span 2;"><hr></div>
            <div style="grid-column: 1 / span 2;"><button id="checkLogin" class="botton buttonblue buttonWider">Join live session</button></div>
        </div>
        <!-- duplicate elements not used (so use same logic in stream and client) -->
        <div class="hidden">Video source</div><div class="custom-select hidden"><select contenteditable="true" id="videoSource"><option value="">None</option></select></div>
        <div class="hidden">Audio source</div><div class="custom-select hidden"><select contenteditable="true" id="audioSource"><option value="">None</option></select> </div>
        <div style="grid-column: 1 / span 2 hidden" id="settingsDialogVideoAudioPreview"><video id="video" class="videosource hidden" autoplay playsinline poster="" muted></video><span id="meterGraph" class="meterGraph hidden"><span id="audiometer" class="meter hiddden"></span></div> 
    </dialog>

    <!----- popup color menu ------>
    <dialog id="paletteDialog" class="toolpopup bottom middle hidden">
            <div>
                <span class="colorpot" value="black" aria-expanded="false" style="background-color: black;"></span>
                <span class="colorpot selectedcolorpot" value="white" aria-expanded="true" style="background-color: white;"></span>
                <span class="colorpot" value="cyan" aria-expanded="false" style="background-color: cyan;"></span>
                <span class="colorpot" value="magenta" aria-expanded="false" style="background-color: magenta;"></span>
                <span class="colorpot" value="yellow" aria-expanded="false" style="background-color: yellow;"></span>
            </div>
    </dialog>

    <!----- Permissions ------>
    <dialog id="permissionsDialog" class="toolpopup top middle hidden">
        <h2>Warning : Microphone or Camera permissions blocked</h2>
        <p>Please check your browser settings to allow access<br>to the microphone and camera for streaming.</p>
        <p>You will be able to mute them at any time.</p>
        <hr>
        <button id="permissionMicHelp" class="botton buttonblue buttonWider"> Click here for more information </button>
    </dialog>
    
    <!----- popup menu microphone mute ------>
    <dialog id="popupMicMuted" class="toolpopup top middle hidden warning">
        <h2 style="color: var(--color-light-bg)">Warning : Your microphone is muted</h2>
    </dialog>

    <!----- popup menu microphone mute ------>
    <dialog id="popupCamMuted" class="toolpopup top middle  hidden notification">
        <h2>Your camera has been turned off</h2>
    </dialog>

    <!----- popup menu microphone mute ------>
    <dialog id="popupStreamMuted" class="toolpopup top middle  hidden notification">
        <h2>Incoming stream muted (You will still hear participants)</h2>
    </dialog>

    <!----- popup stream zoomed popup------>
    <div id="zoom-popup" class="zoom-popup">Stream zoomed</div>

</body>
</html>

<script src="scripts/github.js"></script>   <!-- check github issues for session ID -->
<script src="scripts/deviceselect.js"></script>
<script src="scripts/cookies.js"></script>  <!-- check and store cookies -->
<script src="scripts/initui.js"></script>
<script src="scripts/initvdo.js"></script>
<script src="scripts/interface.js"></script>
<script src="scripts/annotations.js"></script>

<script lang="javascript">
var gitresults = [ ]; //array to hold the results we get back from github

localStorage.clear(); //clear local storage on load to avoid issues with old settings
sessionStorage.clear(); //clear session storage on load to avoid issues with old settings

//get the session id's for the past X days in github.js and then check the session ID against the github issues
getList(); //github.js

//join session button code
const joinSession = document.getElementById("toolJoinSession");
if (joinSession) { joinSession.addEventListener("click", function () { openDialog(sessionDialog, toolJoinSession); 
    document.getElementById("sessionID").focus();
    document.getElementById("popupBG").classList.add("blur");
});}

//checks if an url parameter supplied, if valid, skips the session ID screen goes straight ti user screen
function checkSessionURL (result) {
    //console.log("getlist result :",result);
    let query = location.search;
    let sessionIDURL = query.slice(1);
    let sessionIDUppercase = sessionIDURL.toUpperCase();
    let	sessionID = encodeURIComponent(sessionIDUppercase); 

    result.items.forEach(i=>{
        if (i.title == "SessionID" && i.author_association == "OWNER") { //every item we get back made by owner and has sessionID in the title
            const decodedBody = atob(i.body);   //decrypt and split
            const splitBody = decodedBody.split("&");
        
            gitresults.push (splitBody);

            if (splitBody[0] == sessionID) {  //check against the suplied URL, if it matches decode client name
                checkCookie("username", "camera", "mic"); //cookies.js check cookie data for username, camera and microphone
                
                clientEncoded = splitBody[1];
                client = decodeURIComponent(clientEncoded); //decode the client name

                document.getElementById("sessionTitle").innerHTML = client + " Live session ("+sessionID+")";                //fill in client name and session ID in the interface
                document.getElementById("sessionID").value = sessionID;

                sessionDialog.classList.add("hidden");                //hide session dialog & show user, camera and microphone dialog
                sessionDialog.close();

                openDialog(settingsDialog, toolJoinSession)
                document.getElementById("popupBG").classList.add("blur");
                document.getElementById("name").focus();
                storeSelectedDevices(1,0,0)     //store session ID only
            } 
        }
    })
}

//submit session ID on enter or click, focus field, run checkEnteredSession() function
document.getElementById("sessionID").focus();
document.getElementById("checkSession").addEventListener("click", checkEnteredSession);
document.getElementById("sessionID").addEventListener("keypress", function(event) {
	if (event.key === "Enter") {
		event.preventDefault();
		document.getElementById("checkSession").click();
		}
	});

//if the session ID is 6 characters long then check it against the github issues, if valid then show the client login screen
function checkEnteredSession() {
    const dialogContent = document.querySelector('#sessionDialog .dialogContent');
    const sessionIDEntered = sessionID.value;
    const sessionIDEnteredUppercase = sessionIDEntered.toUpperCase();
    const sessionIDEnteredSanitized = encodeURIComponent(sessionIDEnteredUppercase);

    //check if there is a session ID and if it is 6 characters long
    if (!sessionIDEnteredSanitized || sessionIDEnteredSanitized.length !== 6) {
    dialogContent.classList.remove('shake'); // reset if already animating
    void dialogContent.offsetWidth; // force reflow to restart animation
    sessionID.value = "";
    sessionID.focus();
    dialogContent.classList.add('shake');
        return;
    }
    
    const found = gitresults.find(([id]) => id === sessionIDEnteredSanitized); //compare sanitized ID to results we got from github using async getlist()

    if (found) { //if we found a match then show the user, camera and microphone dialog
        //check cookie data for username, camera and microphone
        storeSelectedDevices(1,0,0) //store session ID only
        checkCookie("username", "camera", "mic"); //cookies.js

        const clientEncoded = found[1];
        const client = decodeURIComponent(clientEncoded);
        document.getElementById("sessionTitle").innerHTML = client + " Live session ("+sessionIDEnteredSanitized+")";
        //hide the seeion dialog & show user, camera and microphone dialog
        sessionDialog.close();
        sessionDialog.classList.add("hidden");
        openDialog(settingsDialog, toolJoinSession)
        document.getElementById("name").focus();
    } else {
        showError();
    }
}

//User, camera and microphone dialogue window submit button and enter actions (run setupSession())
document.getElementById("checkLogin").addEventListener("click", setupSession);
document.getElementById("name").addEventListener("keypress", function(event) {
	if (event.key === "Enter") {
		event.preventDefault();        
		document.getElementById("checkLogin").click();
		}
	});

//check that the user has entered a name and selected a microphone, if yes then start the vdo ninja streams and change the interface
function setupSession() {
    const nameInput = document.getElementById("name");
    const micSelect = document.getElementById("microphoneSource");

    let username = nameInput.value.trim();
    sanitizedUserName = encodeURIComponent(username); 
    //check if the username is empty or no microphone selected
    if (!sanitizedUserName) {
        animateAndFocus(nameInput);
        return;
    }

    function animateAndFocus(element) {
        element.style.animation = "pulse 500ms";
        setTimeout(() => { element.style.animation = "none"; }, 500);
        element.focus();
    }

    //hide the user, camera and microphone dialog
    settingsDialog.close();     
    document.getElementById("settingsDialog").classList.add("hidden");  
    document.getElementById("popupBG").classList.remove("blur");  
    document.getElementById("popupBG").classList.add("hidden");
    document.getElementById("shmeg").classList.add("hidden");
    document.getElementById("mainWindow").classList.remove("hidden");      
    document.body.style.backgroundImage = "none";

    //reset settings dialog to be a settings dialog not a login dialog
    document.getElementById("settingsDialog").classList.remove("top", "middle");        
    document.getElementById("settingsDialog").classList.add("toolpopup", "bottom", "left");
    document.getElementById("camPreview").style.display = "none";
    document.getElementById("checkLogin").innerHTML = "Change settings";
    checkLogin.removeEventListener("click", setupSession);    // Remove start session listener and add settings change listener
    // Events
    window.addEventListener("wheel", onWheel, { passive: false });
    window.addEventListener("mousedown", onMouseDown);
    window.addEventListener("mousemove", onMouseMove);
    window.addEventListener("mouseup", onMouseUp);

    checkLogin.addEventListener("click",() => {
        viewerStream() ; //from initvdo.js
    });

    viewerStream(); //from initvdo.js
    setTimeout(function(){   
        viewMainStream();//from initvdo.js
    },250);
}
</script>
