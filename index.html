<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="0"/>
    <meta name="msapplication-TileColor" content="#2e2e2e"/>
    <meta name="keywords" content="Gui Felix, Advertising, Visual Effects, Motion Graphics, Remote Pixels, vdo.ninja"/>
    <meta name="robots" content="index, follow"/>
    <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="icons/favicon.ico">
    <meta name="color-scheme" content="light dark">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@200" rel="stylesheet" />

    <link rel="stylesheet" href="styles/newstyle.css">
    <title>rpxl.app v2.1</title>
</head>
<!--styles speciic for this page only-->
<style>
.dialoglogin {
    position: relative;
    height: fit-content;
    align-items: center;
    justify-content: center;
    top:  calc(var(--button-height));
    width: 370px;
    padding: 20px;
    color: light-dark(var(--color-light-grey), var(--color-light-grey));
    background-color: light-dark(var(--color-light-bg), var(--color-dark-grey));
    border-radius: var(--radius-big);
    border: var(--border-width) solid light-dark(var(--color-light-white), var(--color-dark-grey));
    z-index: 1;
    box-shadow: var(--shadows);
} 
.dialogModify {
    width: 370px;
} 
.camera {
    display: block;
    position: relative;
    object-fit: cover;
    left: 50%;
    transform: translateX(-50%);
    width: 280px;
    height: 280px;
    border-radius: 100%;
    margin-bottom:20px;
    border: var(--border-width) solid light-dark(var(--color-light-white), var(--color-dark-grey));
    background-color: black;
    transition: opacity 0.5s;
}
.sessionID {
    --w: 30px;   /* control the width for each letter */
    --g: 8px; /* the gap between letters */
    --_n: attr(maxlength type(<integer>)); 

    font-size: 38px;  
    line-height: 40px; /* control the height */
    letter-spacing: var(--w);
    font-family: monospace;
    width: 390px;
    margin-left:8px;
    padding-left:10px;
    padding-top:10px;
    padding-bottom: 5px;
    clip-path: inset(0 80px 0 0);
    justify-content: center;
    background:
    repeating-linear-gradient(90deg,
    light-dark(var(--color-light-white), var(--color-mid-grey)) 0 var(--border-width), /*left edge of block*/
    light-dark(var(--color-light-white), var(--color-mid-grey)) 0 calc(1ch + var(--w) - var(--g) - var(--border-width)),/*colour of the ID blocks*/
    light-dark(var(--color-light-white), var(--color-mid-grey)) 0 calc(1ch + var(--w) - var(--g)), /*right edge o blocks*/
    light-dark(var(--color-light-bg), var(--color-dark-bg)) 0 calc(1ch + var(--w)));/*colour of gaps between the ID blocks*/
}
.mainstreamiframe {
	width: calc(100% - 110px);
    left:305px;
	z-index: 0;
}
.viewersiframe {
	width:110px;
	left:0px;
	overflow-y: auto;
    overflow-x: hidden;
    z-index:2;
}
.viewersiframe:hover {
	width:300px;
    transition-timing-function: linear;
    transition: all 150ms;
}
</style>

<body id="body">
    <!--iframes for vdo ninja-->
    <iframe class="viewersiframe" id="viewersStream"></iframe>
    <iframe class="mainstreamiframe" id="mainStream"></iframe>   

    <!--canvas for drawing annotations-->
    <canvas id="annotationsCanvas" class="annotationsCanvas"></canvas>

<!--enter seasion ID popup-->
    <div class="dialoglogin centerhorizontal" id="session">
		<h2 class="center">Enter a valid Session ID to continue</h2>
        <p></p>
        <div>
            <input type="text" maxlength="6" class="sessionID" id="sessionID" name="username" contenteditable="true" oninput="restrictInput(event)" style="text-transform:uppercase" autofocus autocomplete="off">
            <br>&nbsp;
        </div>
        <div class="center">6 character code supplied by the host</div>
        <div>
            <br>
        </div>
        <div>
            <button id="checkSession" class="botton buttonblue">Continue</button>
        </div>
    </div>

<!--enter username, select camera and microphone-->
    <div class="dialoglogin centerhorizontal hidden" id="create">
        <div id="setupPreview">
            <video id="camera" class="camera fadeout" autoplay playsinline poster=""></video>
            <audio id="microphone" class="loginaudio" autoplay></audio>
        </div>
        <div>
            <span class="label">Name</span>
            <input type="text" maxlength="25" class="textinput" id="name" name="username" placeholder="(Required)" contenteditable="true" autocomplete="off">
        </div>
        <div>
            <span class="label">Camera</span>
            <div class="custom-select">
                <select contenteditable="true" id="cameraSource">
                    <option value="">None</option>
                </select>
            </div>
        </div>
        <div>
            <span class="label">Microphone</span>
            <div class="custom-select">
                <select contenteditable="true" id="microphoneSource">
                    <option value="">None</option>
                </select>
            </div>
        </div>
        <div>
            <br>
        </div>
        <div>
            <button id="checkLogin" class="botton buttonblue">Join live session</button>
        </div>
    </div>
    <!-- duplicate elements not displayed so can re-use camera and microphone code-->
    <div class="row collapsed hidden" id="moresettings">
        <div class="custom-select">
            <select contenteditable="true" id="videoSource">
                <option value="">None</option>
            </select>
        </div>
        <div class="custom-select">
            <select contenteditable="true" id="audioSource">
                <option value="">None</option>
            </select>
        </div>
        <video id="video" class="videosource fadeout" autoplay playsinline poster=""></video>
        <audio id="audio" class="audiosource" autoplay></audio>
    </div>
    <!-- duplicate elements end-->


    <!--Main interface-->
    <div id="mainWindow" class="hidden">

        <!--top menu bar-->
        <div class="toolbar top" id="topmenu">	
           <div class="toolset">
                 <!--<button class="tool" id="switchTheme" value="light">
                    <span class="material-symbols-outlined">routine</span>
                </button>-->
            </div>
            <div>
                <h2 id="sessionTitle" class="centerhorizontal centervertical">RPXL</h2>
            </div>
            <div class="toolset">
                <a href="https://vdo.ninja" target="_blank" style="text-decoration: none">
                    <button class="botton buttonblue" id="vdoninja">
                        <span>&nbsp;&nbsp;&nbsp;Powered by vdo.ninja&nbsp;&nbsp;&nbsp;</span>
                    </button>
                </a>
            </div>
        </div>

        <!--bottom menu bar-->
        <div id="bottomMenu" class="toolbar bottom">

            <!--settings menu-->
            <div class="toolset">
                <button class="tool toolmoresettings" id="settings" aria-expanded="false">
                    <span class="material-symbols-outlined">settings</span>
                </button>
                <div class="popupBG hidden" id="settingsBG">
                </div>
            </div>

            <!--mute camera and microphone-->
            <div class="toolset toolspacer">
                <button class="tool toolred" aria-expanded="false" id="toolMuteMicrophone">
                    <span class="material-symbols-outlined">mic</span>
                </button>
                <button class="tool toolred disable" aria-expanded="false" id="toolMuteCamera" disabled>
                    <span class="material-symbols-outlined">photo_camera</span>
                </button>
            </div>

            <!--annotations-->
            <div class="toolset">
                <button class="tool disable" aria-expanded="false" id="toolDraw" disabled>
                    <span class="material-symbols-outlined">format_ink_highlighter</span>
                </button>
                <button class="tool toolmoresettings disable" aria-expanded="false" id="popupPalette" disabled>
                    <span class="material-symbols-outlined">palette</span>
                </button>
                <!----- popup menu ------>
                <div class="popupBG hidden" id="popupBlockPalette">
                    <div class="toolpopup bottom middle">
                        <div>
                            <span class="colorpot" value="black" aria-expanded="false" style="background-color: black;"></span>
                            <span class="colorpot selectedcolorpot" value="white" aria-expanded="true" style="background-color: white;"></span>
                            <span class="colorpot" value="cyan" aria-expanded="false" style="background-color: cyan;"></span>
                            <span class="colorpot" value="magenta" aria-expanded="false" style="background-color: magenta;"></span>
                            <span class="colorpot" value="yellow" aria-expanded="false" style="background-color: yellow;"></span>
                        </div>
                    </div>
                </div>
                <!----- end popup menu ------>
                <button class="tool disable" aria-expanded="false" id="toolEraser" disabled>
                    <span class="material-symbols-outlined">ink_eraser_off</span>
                </button>
            </div>

            <!--File drop-->
            <div class="toolset toolspacer hidden">
                <button class="tool toolmoresettings" aria-expanded="false" id="toolFileShare">
                    <span class="material-symbols-outlined">cloud_download</span>
                </button>        
            </div>

            <!--spacer-->
            <div class="toolspacer">
  
            </div>
            <!--Mute main stream-->
            <div class="toolset">
                <button class="tool disable" aria-expanded="false" id="toolMuteStream" disabled>
                    <span class="material-symbols-outlined">volume_up</span>
                </button>   
                <span class="volume"><input type="range" id="toolStreamVolume" value="80" min="0" max="100" disabled class="disable"></span>        
            </div>

        </div>
    </div>


    <!-- popups-->
    <!----- Permissions ------>
    <div class="popupBG hidden popupBGImmutable" id="popupPermissionMic" >
        <div class="toolpopup top middle">
            <h2>
            Warning : Microphone or Camera permissions blocked<br>
            </h2>
            <p></p>
            Please check your browser settings to allow access<br>
            to the microphone and camera for streaming.
            <p></p>
            You will be able to mute them at any time.
            <p></p>
            <button id="permissionMicHelp" class="botton buttonblue"> Click here for more info </button>
        </div>
    </div>
    <!----- popup menu microphone mute ------>
    <div class="toolpopup top middle hidden" id="popupMicMuted" style="top:0px">
        <h2>&nbsp;&nbsp;&nbsp; Warning : Your microphone is muted &nbsp;&nbsp;&nbsp;</h2>
    </div>
    <!----- end popup menu ------>
    <!----- popup menu microphone mute ------>
    <div class="toolpopup top middle hidden" id="popupCamMuted" style="top:0px">
        <h2>&nbsp;&nbsp;&nbsp; Your camera has been turned off &nbsp;&nbsp;&nbsp;</h2>
    </div>
    <!----- end popup menu ------>
    <!----- popup menu microphone mute ------>
    <div class="toolpopup top middle hidden" id="popupStreamMuted" style="top:0px">
        <h2>&nbsp;&nbsp;&nbsp; Incoming stream muted (You will still hear participants) &nbsp;&nbsp;&nbsp;</h2>
    </div>
    <!----- end popup menu ------>
</body>
</html>

<!--user microphone and camera selection and display-->
<script src="scripts/videoaudioselect.js"></script>
<script src="scripts/cookie.js"></script>
<script src="scripts/interface.js"></script>
<script src="scripts/annotations.js"></script>
<script src="scripts/github.js"></script>

<script lang="javascript">
////////////////////////////////////////////////////////////////////////////////////////////////////
//globals
////////////////////////////////////////////////////////////////////////////////////////////////////
var gitresults = [ ];
let	sessionIDEnteredSanitized
let sanitizedUserName
let sanitizedCamera
let sanitizedMicrophone
let sessionStarted = false

////////////////////////////////////////////////////////////////////////////////////////////////////
//check the session id's for the allowed dates in github.js and then check the session ID against the github issues
//date range to look for session id's in repo issues currently set to 30 day
////////////////////////////////////////////////////////////////////////////////////////////////////
getList();

async function getList() {
    const url = "https://api.github.com/search/issues?q=repo:remotepixels/rpxl type:issue created:"+backDateyyyymmdd+".."+currentDateyyyymmdd

    const response = await fetch(url, {
        "method": "GET"
    })

    const result = await response.json()
    checkSessionURL(result);
}
////////////////////////////////////////////////////////////////////////////////////////////////////
//check session ID against github issues
//checks the url parameter supplied, if valid shows the client login screen otherwise shows the session ID screen
////////////////////////////////////////////////////////////////////////////////////////////////////
function checkSessionURL (result) {
    let query = location.search;
    let sessionIDURL = query.slice(1);
    let sessionIDUppercase = sessionIDURL.toUpperCase();
    let	sessionID = encodeURIComponent(sessionIDUppercase); 

    result.items.forEach(i=>{
        if (i.title == "SessionID" && i.author_association == "OWNER") { //every item we get back made by owner and has sessionID in the title
            const decodedBody = atob(i.body);   //decrypt and split

            const splitBody = decodedBody.split("&");
            
            gitresults.push (splitBody);
            if (splitBody[0] == sessionID) {  //check against the suplied URL, if it matches decode client name
                clientEncoded = splitBody[1];
                sessionIDEnteredSanitized = sessionID;
                checkCookie("username", "camera", "mic")
                client = decodeURIComponent(clientEncoded); //decode the client name
                document.getElementById("session").classList.add("hidden");
                document.getElementById("create").classList.remove("hidden");
                document.getElementById("sessionTitle").innerHTML = client + " ("+sessionIDEnteredSanitized+")";
                document.getElementById("name").focus();

            } 
        }
    })
}

////////////////////////////////////////////////////////////////////////////////////////////////////
//Entering session ID code if the URL parameter is not supplied or invalid
//set focus to session ID input
//submit session ID if user hits enter key or clicks submit button
////////////////////////////////////////////////////////////////////////////////////////////////////
document.getElementById("sessionID").focus();
document.getElementById("checkSession").addEventListener("click", checkEnteredSession);
document.getElementById("sessionID").addEventListener("keypress", function(event) {
	if (event.key === "Enter") {
		event.preventDefault();
		document.getElementById("checkSession").click();
		}
	});

//quick check to make sure the session ID is 6 characters long
//if not then shake the box and clear input
//if the session ID is 6 characters long then check it against the github issues
//if it is valid then show the client login screen otherwise shke the box and clear input
function checkEnteredSession() {
    let sessionIDEntered = document.getElementById("sessionID").value;
    let sessionIDEnteredUppercase = sessionIDEntered.toUpperCase();
	sessionIDEnteredSanitized = encodeURIComponent(sessionIDEnteredUppercase); 

    if ((sessionIDEnteredSanitized.length != 6) || (sessionIDEnteredSanitized == null)){
		session.style.animation = "shake 500ms";
		setTimeout ( function () {session.style.animation = "none";}, 300);
        document.getElementById("sessionID").value = "";
        document.getElementById("sessionID").focus();
    } else { 
        for (let i = 0; i < gitresults.length; i++) {
            if (gitresults[i][0] == sessionIDEnteredSanitized) { 

                checkCookie("username", "camera", "mic")
                
                clientEncoded = gitresults[i][1];
                client = decodeURIComponent(clientEncoded)

                document.getElementById("session").classList.add("hidden");
                document.getElementById("create").classList.remove("hidden");
                document.getElementById("sessionTitle").innerHTML = client + " ("+sessionIDEnteredSanitized+")";
                document.getElementById("name").focus();
                
                break;
            }
        }
        //console.log("Session ID not found");
        session.style.animation = "shake 500ms";
        setTimeout ( function () {session.style.animation = "none";}, 300);
        document.getElementById("sessionID").value = "";
        document.getElementById("sessionID").focus();
    }
}


////////////////////////////////////////////////////////////////////////////////////////////////////
//User and camera, microphone dialogue window
//set focus to the name field
//the camera and microphone fields are populated with the available devices using the videoaudioselect.js script
////////////////////////////////////////////////////////////////////////////////////////////////////
document.getElementById("name").focus();
document.getElementById("checkLogin").addEventListener("click", joinSession);

document.getElementById("name").addEventListener("keypress", function(event) {
	if (event.key === "Enter") {
		event.preventDefault();        
		document.getElementById("checkLogin").click();
		}
	});

////////////////////////////////////////////////////////////////////////////////////////////////////
//Join seesion code and change settings code
//check that the user has enetered a name and selected a microphone
//if yes then start the main stream and client stream or change the client stream settings
////////////////////////////////////////////////////////////////////////////////////////////////////
function joinSession() {
    let username = document.getElementById("name").value;
    sanitizedUserName = encodeURIComponent(username); 
    //check if the username is empty or no microphone selected
    if (sanitizedUserName == "") {
        document.getElementById("name").style.animation = "pulse 250ms";
        setTimeout ( function () {document.getElementById("name").style.animation = "none"; }, 250);  
        document.getElementById("name").focus(); 
    //check we've selected a microphone
    } else if ( document.getElementById("microphoneSource").selectedIndex == 0) {
        document.getElementById("microphoneSource").style.animation = "pulse 250ms";
        setTimeout ( function () {document.getElementById("microphoneSource").style.animation = "none"; }, 250);  
        document.getElementById("microphoneSource").focus(); 
    //moving on    
    } else {  
        //if the username is not empty then stop streams so not to conflict with the vdo ninja ones
        stream.getTracks().forEach(function(track) {
            track.stop();
        });

        //get the select values for the slected camera and microphone
        let cameraList = document.getElementById("cameraSource");
        let microphoneList = document.getElementById("microphoneSource");

        //get the index of the selected camera and microphone
        let cameraSelected = cameraList.selectedIndex;
        let microphoneSelected = microphoneList.selectedIndex;

        //get actual field values of the selected camera and microphone not their index
        let camera = cameraList.options[cameraSelected].text;
        let microphone = microphoneList.options[microphoneSelected].text;

        //sanitize the values for vdo.ninja
        sanitizedCamera = cameraList.options[cameraSelected].text.toLowerCase().replace(/[\W]+/g, "_");
        sanitizedMicrophone = microphoneList.options[microphoneSelected].text.toLowerCase().replace(/[\W]+/g, "_");      
        //if there is no camera or microphone selected then set the value to 0 for vdo.ninja
        if (sanitizedCamera == "none") {
            sanitizedCamera = "0"
        }
        //this should never happen but just in case
        if (sanitizedMicrophone == "none") {
            sanitizedMicrophone = "0"
        }
        //reset mic stutus if it was muted before and we changed the source
        if (toolMuteMicrophone.getAttribute("aria-expanded") == "true") {toolMuteMicrophoneSelect ()};
        if (toolMuteCamera.getAttribute("aria-expanded") == "true") {toolMuteCameraSelect ()};
        //disable the camera button if no camera selected or if blocked by browser
        if ((sanitizedCamera == 0) || (sanitizedCamera == "disabled_in_browser")) {
            document.getElementById("toolMuteCamera").classList.add("disable");
            document.getElementById("toolMuteCamera").disabled = true;
        } 

        //run only the first time the user enters the session there after not necessary
        if (sessionStarted == false) {                   
            //hide the login screen and show the main window and reposition the elements for the settings menu
            document.getElementById("create").classList.remove("centerhorizontal", "dialoglogin");        
            document.getElementById("create").classList.add("toolpopup", "bottom", "left", "dialogModify", "hidden");
            document.getElementById("setupPreview").style.display = "none";
            document.getElementById("checkLogin").innerHTML = "Apply settings";
            
            document.getElementById("mainWindow").classList.remove("hidden");
            mainstream ();
        } else {
            document.getElementById("create").classList.add("hidden");
            document.getElementById("settings").setAttribute("aria-expanded", "false");
            document.getElementById("settingsBG").classList.add("hidden");
        }
        //save the username, camera and microphone to cookies, make valid for 7 days
        setCookie("username", sanitizedUserName, 7);
        setCookie("camera", camera, 7);
        setCookie("mic", microphone, 7);
        //start viewerstream
        viewerStream ();

        //set that we have started the main stream
        sessionStarted = true;
    }
}

////////////////////////////////////////////////////////////////////////////////////////////////////
//start the main stream
////////////////////////////////////////////////////////////////////////////////////////////////////
function mainstream () {
    document.getElementById("mainStream").style.display = "block";
    document.getElementById("mainStream").allow = "autoplay;screen-wake-lock;autoplay";
    document.getElementById("mainStream").src = "https://vdo.rpxl.app/?room=RPXL_"+sessionIDEnteredSanitized+
    "&view=Stream_"+sessionIDEnteredSanitized+
    //"&directoronly"+
    "&solo"+//no login options, solos stream
    "&clean"+//remove all interface bits
    "&hideplaybutton"+//hides big play button if autoplay is disabled
    "&transparent"+//makes bg transparent
    "&preloadbitrate=-1"+//preloads the video, might not be necessary as only use scene 1
    "&rampuptime=6000"+
    "&waitimage=https%3A%2F%2Falpha.rpxl.app%2Fimages%2FnosignalHD.png"+
    "&buffer=1000"+//adds a xms buffer
    "&showlist=0"+//hides the viewer list
    "&js=https%3A%2F%2Falpha.rpxl.app%2Fscripts%2Fvdomain.js"+
    "";       
}

////////////////////////////////////////////////////////////////////////////////////////////////////
//start the chat stream
////////////////////////////////////////////////////////////////////////////////////////////////////
function viewerStream () {
    document.getElementById("viewersStream").classList.add("hidden");

    //if no video source is selected or the camera is disabled in the browser then set to connect as miconly
    if ((sanitizedCamera == 0) || (sanitizedCamera == "disabled_in_browser")) {
        var camOrMicSetup = "videodevice=0";
    }   else {
        var camOrMicSetup = "&videodevice="+sanitizedCamera+"&quality=3&videobitrate=196&viewwidth=160&viewheight=90";
    }
    document.getElementById("viewersStream").allow = "autoplay;screen-wake-lock;autoplay;camera *;microphone *;picture-in-picture;display-capture;";
    document.getElementById("viewersStream").src = "https://vdo.rpxl.app/?room=RPXL_"+sessionIDEnteredSanitized+
            "&label="+sanitizedUserName+
            "&style=4"+
            "&meterstyle=2"+
            "&showlabels"+
            "&disablehotkeys"+
            "&"+camOrMicSetup+
            "&webcam"+
            "&audiodevice="+sanitizedMicrophone+
            "&autostart"+
            "&cleanoutput"+
            "&transparent"+
            "&group=Client"+
            "&avatar=https%3A%2F%2Falpha.rpxl.app%2Fimages%2Favatar.png"+
            "&css=https%3A%2F%2Falpha.rpxl.app%2Fstyles%2Fviewersstream.css";

    setTimeout(function(){   
        document.getElementById("viewersStream").classList.remove("hidden");
    },1500);
    }
</script>
