<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
        <meta http-equiv="Pragma" content="no-cache"/>
        <meta http-equiv="Expires" content="0"/>
        <meta name="msapplication-TileColor" content="#2e2e2e"/>
        <meta name="keywords" content="Gui Felix, Advertising, Visual Effects, Motion Graphics, Remote Pixels, vdo.ninja"/>
        <meta name="robots" content="index, follow"/>
        <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
        <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
    
        <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
        <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
        <link rel="shortcut icon" href="icons/favicon.ico">
        <meta name="color-scheme" content="light dark">

        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@200" rel="stylesheet" />

        <link rel="stylesheet" href="styles/newstyle.css">
        <title>rpxl.app v2.1</title>
    </head>

<style>

.dialoglogin {
    position: relative;
    height: fit-content;
    align-items: center;
    justify-content: center;
    top:  calc(var(--button-height) + 15px);
    width: 452px;
    padding: 20px;
    color: light-dark(var(--color-light-grey), var(--color-light-grey));
    background-color: light-dark(var(--color-light-bg), var(--color-dark-bg));
    border-radius: var(--radius-big);
    border: var(--border-width) solid light-dark(var(--color-light-white), var(--color-dark-grey));
    z-index: 3;
    box-shadow: var(--shadows);
} 
.camera {
    display: block;
    position: relative;
    object-fit: cover;
    left: 50%;
    transform: translateX(-50%);
    width: 300px;
    height: 300px;
    border-radius: 100%;
    margin-bottom:20px;
    border: var(--border-width) solid light-dark(var(--color-light-white), var(--color-dark-grey));
    background-color: black;
    transition: opacity 0.5s;
}
.sessionID {
    --w: 40px;   /* control the width for each letter */
    --g: 10px; /* the gap between letters */
    --_n: attr(maxlength type(<integer>)); 

    font-size: 50px;  
    line-height: 50px; /* control the height */
    letter-spacing: var(--w);
    font-family: monospace;
    width: 486px;
    padding-left:15px;
    padding-top:10px;
    padding-bottom: 5px;
    clip-path: inset(0 70px 0 0);
    justify-content: center;
    background:
    repeating-linear-gradient(90deg,
    light-dark(var(--color-light-white), var(--color-dark-grey)) 0 var(--border-width), /*left edge of block*/
    light-dark(var(--color-light-white), var(--color-dark-grey)) 0 calc(1ch + var(--w) - var(--g) - var(--border-width)),/*colour of the ID blocks*/
    light-dark(var(--color-light-white), var(--color-dark-grey)) 0 calc(1ch + var(--w) - var(--g)), /*right edge o blocks*/
    light-dark(var(--color-light-bg), var(--color-dark-bg)) 0 calc(1ch + var(--w)));/*colour of gaps between the ID blocks*/
}


iframe {
	width: calc(100% - 10px);
	height: calc(100% - var(--button-height) - var(--button-height) - 20px);
    top: calc(0px + var(--button-height) + 10px);
    margin-left: 5px;
	border:0px;
	padding:0px;
	position:absolute;
	display:block;
}
.mainstreamiframe {
	width: calc(100% - 105px);
	z-index: 0;
    color-scheme: light;

}
.viewersiframe {
	width:100px;
	right:0px;
	z-index:1;
	overflow-y: auto;
    overflow-x: hidden;
    color-scheme: light;
}
.viewersiframe:hover {
	width:300px;
    transition: all 150ms;
}
.popupBG {
    position: fixed;
    width:100%;
    height:100%;
    top:0;
    left:0;
    background-color: rgba(0, 0, 0, 0);
    z-index: 1;
}
</style>

<body>
<!--enter seasion ID popup-->
    <div class="dialoglogin centerhorizontal" id="session">
		<h2 class="center">Enter a valid Session ID to continue</h2>
        <p></p>
        <div>
            <input type="text" maxlength="6" class="sessionID" id="sessionID" name="username" contenteditable="true" oninput="restrictInput(event)" style="text-transform:uppercase" autofocus autocomplete="off">
            <br>&nbsp;
        </div>
        <div class="center">6 character code supplied by the host</div>
        <div>
            <br>
        </div>
        <div>
            <button id="checkSession" class="botton buttonblue">Continue</button>
        </div>
    </div>
<!--enter username, select camera and microphone-->
    <div class="dialoglogin centerhorizontal hidden" id="login">
		<h2></h2>
        <div>
            <video id="camera" class="camera fadeout" autoplay playsinline poster=""></video>
            <audio id="microphone" class="loginaudio" autoplay></audio>
        </div>
        <div>
            <span class="label">Name</span>
            <input type="text" maxlength="25" class="textinput" id="name" name="username" placeholder="Your name... (Required)" contenteditable="true" autocomplete="off">
        </div>
        <div>
            <span class="label">Camera</span>
            <div class="custom-select">
                <select contenteditable="true" id="cameraSource">
                    <option value="">None</option>
                </select>
            </div>
        </div>
        <div>
            <span class="label">Microphone</span>
            <div class="custom-select">
                <select contenteditable="true" id="microphoneSource">
                    <option value="">None</option>
                </select>
            </div>
        </div>
        <hr>
        <div>
            <button id="checkLogin" class="botton buttonblue">Join live session</button>
        </div>
    </div>
    <!-- duplicate elements not displayed so can re-use camera and microphone code-->
    <div class="row collapsed hidden" id="moresettings">
        <div class="custom-select">
            <select contenteditable="true" id="videoSource">
                <option value="">None</option>
            </select>
        </div>
        <div class="custom-select">
            <select contenteditable="true" id="audioSource">
                <option value="">None</option>
            </select>
        </div>
        <video id="video" class="videosource fadeout" autoplay playsinline poster=""></video>
        <audio id="audio" class="audiosource" autoplay></audio>
    </div>
    <!-- duplicate elements not displayed so can re-use camera and microphone code-->


<!--Main interface-->
    <div id="mainWindow" class="hidden">
        <!--top menu bar-->
        <div class="toolbar top">	
           <div class="toolset">
                 <!--<button class="tool" id="switchTheme" value="light">
                    <span class="material-symbols-outlined">routine</span>
                </button>-->
            </div>
            <div>
                <h2 id="clientName" class="centerhorizontal centervertical">RPXL</h2>
            </div>
           <div class="toolset">
                <!-- <button class="tool toolred" id="quit">
                    <span class="material-symbols-outlined">mode_off_on</span>
                </button>-->
            </div>
        </div>
        
        <iframe title="mainStream" class="mainstreamiframe" id="mainStream"></iframe>
        <iframe title="viewersStream" class="viewersiframe" id="viewersStream"></iframe>

        <div id="bottomMenu" class="toolbar bottom">
            <div class="toolset toolspacer">
                <button class="tool" aria-expanded="false" id="toolMuteStream">
                    <span class="material-symbols-outlined">volume_up</span>
                </button>   
                <span class="volume"><input type="range" id="toolStreamVolume" value="80" min="0" max="100"/></span>        
            </div>

            <div class="toolset toolspacer">
                <button class="tool" aria-expanded="false" id="toolDraw">
                    <span class="material-symbols-outlined">format_ink_highlighter</span>
                </button>
                <button class="tool toolmoresettings" aria-expanded="false" id="popupPalette">
                    <span class="material-symbols-outlined">palette</span>
                </button>
                <!----- popup menu ------>
                <div class="popupBG hidden" id="popupBlockPalette">
                    <div class="toolpopup bottom middle" onclick="event.stopPropagation()">
                            <div>
                                <span class="colorpot" value="black" style="background-color: black;"></span>
                                <span class="colorpot" value="white" style="background-color: white;"></span>
                                <span class="colorpot" value="red" style="background-color: red;"></span>
                                <span class="colorpot" value="green" style="background-color: green;"></span>
                                <span class="colorpot" value="blue" style="background-color: blue;"></span>
                            </div>

                    </div>
                </div>
                <!----- end popup menu ------>
                <button class="tool" aria-expanded="false">
                    <span class="material-symbols-outlined">ink_eraser_off</span>
                </button>

            </div>


            <div class="toolset">
                <button class="tool toolred" aria-selected="false" id="toolMuteMicrophone">
                    <span class="material-symbols-outlined">mic</span>
                </button>
                <button class="tool toolred" aria-expanded="false" id="toolMuteCamera" >
                    <span class="material-symbols-outlined">photo_camera</span>
                </button>
            </div>


            <div class="toolset">
                <button class="tool toolmoresettings" id="popupSettings" aria-expanded="false">
                    <span class="material-symbols-outlined">settings</span>
                </button>
                <!----- popup menu ------>
                <div class="popupBG hidden" id="popupBlockSettings">
                    <div class="toolpopup bottom right" id="settings" onclick="event.stopPropagation()">
                        <h2>Settings</h2>
                            <div>
                                <span class="label">Camera</span>
                                <div class="custom-select">
                                    <select contenteditable="true" id="cameraChange">
                                        <option value="">None</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <span class="label">Microphone</span>
                                <div class="custom-select">
                                    <select contenteditable="true" id="microphoneChange">
                                        <option value="">None</option>
                                    </select>
                                </div>
                            </div>
                            <p></p>
                            <div>
                                <button id="changeCameraAndMicrophone" class="botton buttonblue">Apply</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!----- end popup menu ------>
            </div>



        </div>
    </div>
</body>
</html>

<!--user microphone and camera selection and display-->
<script src="scripts/videoaudioselect.js"></script>
<script src="scripts/cookie.js"></script>


<script>
//////////////////////////////////////////////////
//toolbar code
toolMuteStream.addEventListener("click", function() { toolMuteStreamSelect(); });
toolStreamVolume.addEventListener("click", function() { toolStreamVolumeSelect(); });

toolDraw.addEventListener("click", function() { toolDrawSelect(); });
popupPalette.addEventListener("click", function() { showPopupMenu(popupPalette); });
popupBlockPalette.addEventListener("click", function() { hidePopupMenu(popupBlockPalette); });

toolMuteMicrophone.addEventListener("click", function() { toolMuteMicrophoneSelect(); });
toolMuteCamera.addEventListener("click", function() { toolMuteCameraSelect(); });

popupSettings.addEventListener("click", function() { showPopupMenu(popupSettings); });
popupBlockSettings.addEventListener("click", function() { hidePopupMenu(popupBlockSettings); });
changeCameraAndMicrophone.addEventListener("click", function () { changeCameraAndMicrophoneSelect(); });


function toolMuteStreamSelect () {
    if (toolMuteStream.getAttribute("aria-expanded") == "false") {
        toolMuteStream.setAttribute("aria-expanded", "true");
        toolMuteStream.classList.toggle("selected");  
        toolMuteStream.lastElementChild.innerHTML = "volume_off";
        toolStreamVolume.value = "0";
        mainStream.contentWindow.postMessage({
            "volume": true
        }, '*');
        console.log("main stream mute")
    } else {
        toolMuteStream.setAttribute("aria-expanded", "false");
        toolMuteStream.classList.toggle("selected"); 
        toolMuteStream.lastElementChild.innerHTML = "volume_up";
        toolStreamVolume.value = "80";
        mainStream.contentWindow.postMessage({
            "volume": 80
        }, '*');
        console.log("main stream un-mute")
    }
}

function toolStreamVolumeSelect () {
        toolMuteStream.setAttribute("aria-expanded", "false");
        toolMuteStream.classList.remove("selected"); 
        toolMuteStream.lastElementChild.innerHTML = "volume_up";
        let vol = document.getElementById("toolStreamVolume").value
        mainStream.contentWindow.postMessage({
            "volume": vol
        }, '*');
        console.log("main stream volume",vol)
    }


function toolDrawSelect () {
    if (toolDraw.getAttribute("aria-expanded") == "false") {
        toolDraw.setAttribute("aria-expanded", "true");
        toolDraw.classList.toggle("selected");  
    } else {
        toolDraw.setAttribute("aria-expanded", "false");
        toolDraw.classList.toggle("selected"); 
    }
}

function hidePopupMenu(event) {
    event.classList.add("hidden");
    event.previousElementSibling.setAttribute("aria-expanded", "false");
    }

function showPopupMenu(event) {
    if (event.nextElementSibling.classList.contains("hidden")) {
        event.nextElementSibling.classList.remove("hidden");
        event.setAttribute("aria-expanded", "true");
       
    } else {
        event.nextElementSibling.classList.add("hidden");
        event.setAttribute("aria-expanded", "false");
    }
}

function toolMuteMicrophoneSelect () {
    if (toolMuteMicrophone.getAttribute("aria-expanded") == "false") {
        toolMuteMicrophone.setAttribute("aria-expanded", "true");
        toolMuteMicrophone.classList.toggle("selectedred");  
        toolMuteMicrophone.lastElementChild.innerHTML = "mic";
        viewersStream.contentWindow.postMessage({
            "mic": true
        }, '*');
        console.log("mic mute")
    } else {
        toolMuteMicrophone.setAttribute("aria-expanded", "false");
        toolMuteMicrophone.classList.toggle("selectedred"); 
        toolMuteMicrophone.lastElementChild.innerHTML = "mic_off";
        viewersStream.contentWindow.postMessage({
            "mic": false
        }, '*');
        console.log("mic un-mute")
    }
}

function toolMuteCameraSelect () {
    if (toolMuteCamera.getAttribute("aria-expanded") == "false") {
        toolMuteCamera.setAttribute("aria-expanded", "true");
        toolMuteCamera.classList.toggle("selectedred");  
        toolMuteCamera.lastElementChild.innerHTML = "no_photography";
        viewersStream.contentWindow.postMessage({
            "camera": false
        }, '*');
        console.log("camera off")
    } else {
        toolMuteCamera.setAttribute("aria-expanded", "false");
        toolMuteCamera.classList.toggle("selectedred"); 
        toolMuteCamera.lastElementChild.innerHTML = "photo_camera";
        viewersStream.contentWindow.postMessage({
            "camera": true
        }, '*');
        console.log("camera on")
    }
}

/////////////////////////////////////////////////////
//set focus to session ID input
document.getElementById("sessionID").focus();
checkSession.addEventListener("click", checkEnteredSession);

//submit session ID if user hits enter key
sessionID.addEventListener("keypress", function(event) {
	if (event.key === "Enter") {
		event.preventDefault();
		document.getElementById("checkSession").click();
		}
	});

//check if cookies exist
function checkCookie(cookieUser, cookieCamera, cookieMic) {
    let usercookie = getCookie(cookieUser);
    let cameracookie = getCookie(cookieCamera);
    let miccookie = getCookie(cookieMic);

    if (usercookie != null) {
        console.log("user name in cookie" + usercookie);
        document.getElementById("name").value = usercookie;
    } 

    if (cameracookie != "") {
        console.log("camera " + cameracookie);
        } 

    if (miccookie != "") {
        console.log("mic " + miccookie);
    } 
}

checkCookie("username", "camera", "mic");

//////////////////////////////////////////////
//limit session ID to letters and numbers only
var regex = /^[a-zA-Z0-9]*$/;
var lastValue = "";

function restrictInput(e) {
	var currentValue = e.target.value;

	if (!currentValue.match(regex))
		e.target.value = lastValue;
	else
		lastValue = currentValue;
}
//////////////////////////////////////////////
//get session ID from github issues
//date range to look for session id's in repo issues (currently 3 days)
const currentDate = new Date();
var backDate = new Date();

backDate.setDate(backDate.getDate() - 3);

//change date format to yyyy-mm-dd for search query
const formatDate = (date) => {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
    const day = String(date.getDate()).padStart(2, '0');

    return `${year}-${month}-${day}`;
};

currentDateyyyymmdd = (formatDate(currentDate));
backDateyyyymmdd = (formatDate(backDate));

//search repos for issues
async function getList() {
    const url = "https://api.github.com/search/issues?q=repo:remotepixels/rpxl type:issue created:"+backDateyyyymmdd+".."+currentDateyyyymmdd

    const response = await fetch(url, {
        "method": "GET"
    })

    const result = await response.json()
    checkSessionURL(result);
}

var gitresults = [ ];
let	sessionIDEnteredSanitized
let sanitizedUserName
let sanitizedCamera
let sanitizedMicrophone

getList();

//////////////////////////////////////////////
//check session ID against github issues
//checks the url parameter supplied, if valid shows the client login screen otherwise shows the session ID screen
function checkSessionURL (result) {
    let query = location.search;
    let sessionIDURL = query.slice(1);
    let sessionIDUppercase = sessionIDURL.toUpperCase();
    let	sessionID = encodeURIComponent(sessionIDUppercase); 

    result.items.forEach(i=>{
        if (i.title == "SessionID" && i.author_association == "OWNER") { //every item we get back made by owner and has sessionID in the title
            const decodedBody = atob(i.body);   //decrypt and split

            const splitBody = decodedBody.split("&");
            
            gitresults.push (splitBody);
            if (splitBody[0] == sessionID) {  //check against the suplied URL, if it matches decode client name
                clientEncoded = splitBody[1];
                sessionIDEnteredSanitized = sessionID;
                client = decodeURIComponent(clientEncoded); //decode the client name
                document.getElementById("session").classList.add("hidden");
                document.getElementById("login").classList.remove("hidden");
                document.getElementById("clientName").innerHTML = client + " ("+sessionIDEnteredSanitized+")";
                document.getElementById("name").focus();
            } 
        }
    })
}
//cleans up the session ID entered by user and checks it against the github issues for the past 3 days
function checkEnteredSession() {
    let sessionIDEntered = document.getElementById("sessionID").value;
    let sessionIDEnteredUppercase = sessionIDEntered.toUpperCase();
	sessionIDEnteredSanitized = encodeURIComponent(sessionIDEnteredUppercase); 

    if ((sessionIDEnteredSanitized.length != 6) || (sessionIDEnteredSanitized == null)){
		session.style.animation = "shake 500ms";
		setTimeout ( function () {session.style.animation = "none";}, 300);
        document.getElementById("sessionID").value = "";
        document.getElementById("sessionID").focus();
    } else {    //check session id to github issues
        for (let i = 0; i < gitresults.length; i++) {
            if (gitresults[i][0] == sessionIDEnteredSanitized) { 
                clientEncoded = gitresults[i][1];
                client = decodeURIComponent(clientEncoded)

                document.getElementById("session").classList.add("hidden");
                document.getElementById("login").classList.remove("hidden");
                document.getElementById("clientName").innerHTML = client + " ("+sessionIDEnteredSanitized+")";
                document.getElementById("name").focus();
                //console.log(sessionIDEnteredSanitized);
                //console.log(client);
                break;
            }
        }
        //console.log("Session ID not found");
        session.style.animation = "shake 500ms";
        setTimeout ( function () {session.style.animation = "none";}, 300);
        document.getElementById("sessionID").value = "";
        document.getElementById("sessionID").focus();
    }
}

//////////////////////////////////////////////
//check that a username has been entered
//start the client session with the selected camera and microphone
const checkLogin = document.getElementById("checkLogin");
checkLogin.addEventListener("click", joinSession);

const nameField = document.getElementById("name");
nameField.addEventListener("keypress", function(event) {
	if (event.key === "Enter") {
		event.preventDefault();
		document.getElementById("checkLogin").click();
		}
	});

function joinSession() {
    //stop all streams hide audio and video object to make sure 
    stream.getTracks().forEach(function(track) {
        track.stop();
    });
//    camera.style.display = "none";
//    microphone.style.display = "none";


    let username = document.getElementById("name").value;
    let cameraList = document.getElementById("cameraSource");
    let microphoneList = document.getElementById("microphoneSource");
    
    //let login = document.getElementById("login")

    //get the index of the selected camera and microphone
    let cameraSelected = cameraList.selectedIndex;
    let microphoneSelected = microphoneList.selectedIndex;

    //used uri encoded to write the values to the cookie
    let camera = cameraList.options[cameraSelected].text;
    let microphone = microphoneList.options[microphoneSelected].text;

    let uriEncodedCamera = encodeURIComponent(camera);
    let uriEncodedMicrophone = encodeURIComponent(microphone);

    //get the selected camera and microphone device names (shown in the menu, not the values)
    sanitizedUserName = encodeURIComponent(username);   
    sanitizedCamera = cameraList.options[cameraSelected].text.toLowerCase().replace(/[\W]+/g, "_");
    sanitizedMicrophone = microphoneList.options[microphoneSelected].text.toLowerCase().replace(/[\W]+/g, "_");

    //if there is no camera or microphone selected then set the value to 0 for vdo.ninja
    if (sanitizedCamera == "none") {
        sanitizedCamera = "0"
    }
    if (sanitizedMicrophone == "none") {
        sanitizedMicrophone = "0"
    }
    
    //if no username then flash the field and do nothing
    if (sanitizedUserName == "") {
        document.getElementById("name").style.animation = "pulse 250ms";
        setTimeout ( function () {document.getElementById("name").style.animation = "none"; }, 250);  
        document.getElementById("name").focus();
    } else {            //set some cookies and start the session
        setCookie("username", sanitizedUserName, 7);
        setCookie("camera", uriEncodedCamera, 7);
        setCookie("mic", uriEncodedMicrophone, 7);

        document.getElementById("login").classList.add("hidden");
        document.getElementById("mainWindow").classList.remove("hidden");

        //copy options tool settings menu for later
        var select1 = document.getElementById("cameraSource");
        var options = select1.innerHTML
        var select2 = document.getElementById("cameraChange");
        select2.innerHTML = options
        select2.selectedIndex = cameraList.selectedIndex;

        var select1 = document.getElementById("microphoneSource");
        var options = select1.innerHTML
        var select2 = document.getElementById("microphoneChange");
        select2.innerHTML = options
        select2.selectedIndex = microphoneList.selectedIndex;

        //start mainstream and client streams
        mainstream ()
        setTimeout(function(){ viewerStream ()	},1000);
    }
}


function mainstream () {
    document.getElementById("mainStream").allow = "autoplay; screen-wake-lock;";

    document.getElementById("mainStream").src = "https://vdo.rpxl.app/?room=RPXL_"+sessionIDEnteredSanitized+
    "&directorsonly"+ 	//show only directors feed
    "&solo"+	//no login options, solos stream
    "&cleanoutput"+	//remove all interface bits
    "&hideplaybutton"+	//hides big play button if autoplay is disabled
    "&cv"+	//clean viewer
    "&transparent"+	//makes bg transparent
    "&preloadbitrate=-1"+	//preloads the video, might not be necessary as only use scene 1
    "&rampuptime=6000"+
    "&waitimage=https%3A%2F%2Falpha.rpxl.app%2Fimages%2FnosignalHD.png"+
    "&buffer=1000"+	//adds a xms buffer
    "&showlist=0"+	//hides the viewer list
    "&js=https%3A%2F%2Falpha.rpxl.app%2Fscripts%2Fvdomain.js"+
    "";       
}

function viewerStream () {
    document.getElementById("viewersStream").allow = "autoplay; camera *; microphone *;";

    document.getElementById("viewersStream").src = "https://vdo.rpxl.app/?room=RPXL_"+sessionIDEnteredSanitized+
    "&label="+sanitizedUserName+	//sets webcam as label for client connection
    "&showlabels"+
    "&group=client"+
    "&avatar=https%3A%2F%2Falpha.rpxl.app%2Fimages%2Favatar.png"+
    "&showall"+
    "&groupmode"+
    "&videodevice="+sanitizedCamera+ //video source
    "&audiodevice="+sanitizedMicrophone+ //audio source
    "&autostart"+   //autostart directors feed
    "&clean"+
    "&quality=3"+	//set camera quality to lowest possible, about 360p
    "&webcam"+	//disables screenshare use &webcam2 to show share your camera screen
    "&videobitrate=256"+
    "&viewwidth=160&viewheight=90"+	//sets incoming video to px size (very low res)
    "&style=6"+	//show audio only sources as coloured circles with first letter of name
    "&meterstyle=5"+	//round highlight over person talking
    "&transparent"+	//makes bg transparent
    "&disablehotkeys"+	//no hotkeys
    "&css=https%3A%2F%2Falpha.rpxl.app%2Fstyles%2Fviewersstream.css"+	//load style sheet
    ""; 
}

function changeCameraAndMicrophoneSelect () {

    document.getElementById("viewersStream").classList.add("hidden");

    var currentMicrophoneIndex = document.getElementById("microphoneSource").selectedIndex;
    var currentCameraIndex = document.getElementById("cameraSource").selectedIndex;

    var newMicrophoneIndex = document.getElementById("microphoneChange").selectedIndex;
    var newCameraIndex = document.getElementById("cameraChange").selectedIndex;

    currentMicrophoneIndex = newMicrophoneIndex;

    let newMicrophone = document.getElementById("microphoneSource");
    sanitizedMicrophone = newMicrophone.options[newMicrophoneIndex].text.toLowerCase().replace(/[\W]+/g, "_");

    //if there is no camera or microphone selected then set the value to 0 for vdo.ninja
    if (sanitizedMicrophone == "none") {
        sanitizedMicrophone = "0"
    }


    currentCameraIndex = newCameraIndex;
    let newCamera = document.getElementById("cameraSource");
    sanitizedCamera = newCamera.options[newCameraIndex].text.toLowerCase().replace(/[\W]+/g, "_");

    //if there is no camera or microphone selected then set the value to 0 for vdo.ninja
    if (sanitizedCamera == "none") {
        sanitizedCamera = "0"
    }
    
    console.log("new camera selected", sanitizedCamera)
    console.log("new mic selected", sanitizedMicrophone)


    //stop current streams make sure video and audio objects are hidden
    viewersStream.contentWindow.postMessage({
            "hangup": true
        }, '*');
    camera.style.display = "none";
    microphone.style.display = "none";
    console.log("stopping current streams")

    //restart the client stream
    viewerStream ()
    /*
    document.getElementById("viewersStream").src = "https://vdo.rpxl.app/?room=RPXL_"+sessionIDEnteredSanitized+
    "&label="+sanitizedUserName+	//sets webcam as label for client connection
    "&showlabels"+
    "&group=client"+
    "&avatar=https%3A%2F%2Frpxl.app%2Fimages%2Favatar.png"+
    "&showall"+
    "&groupmode"+
    "&videodevice="+sanitizedCamera+ //video source
    "&audiodevice="+sanitizedMicrophone+ //audio source
    "&autostart"+   //autostart directors feed
    "&clean"+
    "&quality=3"+	//set camera quality to lowest possible, about 360p
    "&webcam"+	//disables screenshare use &webcam2 to show share your camera screen
    "&videobitrate=100"+
    "&viewwidth=160&viewheight=90"+	//sets incoming video to px size (very low res)
    "&style=6"+	//show audio only sources as coloured circles with first letter of name
    "&meterstyle=5"+	//round highlight over person talking
    "&transparent"+	//makes bg transparent
    "&disablehotkeys"+	//no hotkeys
    "&css=https%3A%2F%2Frpxl.app%2Fstyles%2Fviewersstream.css"+	//load style sheet
    ""; 
        */
    //reset button, hide popup and show client frame
    popupBlockSettings.classList.add("hidden");
    popupSettings.setAttribute("aria-expanded", "false");
    popupBlockSettings.setAttribute("aria-expanded", "false");

    setTimeout(function(){ document.getElementById("viewersStream").classList.remove("hidden");},1000);
    
}


    function resize() {
// Get a reference to the iframe
const iframe = document.getElementById('mainStream');
    // Use postMessage to send data to the iframe
    iframe.contentWindow.postMessage('Hello from parent!', 'https://vdo.rpxl.app');

    // Listen for messages from the iframe
    window.addEventListener('message', (event) => {
        // Check if the message is from the expected origin
        if (event.origin === 'https://vdo.rpxl.app') {
            console.log('Received message from iframe:', event.data);
        }
    });
}


window.onresize = resize;
resize();


    		//"&videobitrate=50000"+ //server limited but hey, ask for as much as possible
            //"&minipreview"+
            //"&bgimage=https%3A%2F%2Frpxl.app%2Fimages%2Favatar-background.jpg"+
            //"&chatbutton=0"+
            //"&rounded=10"+	//makes videos round
            //"&safemode"+	//loads camera in simplist way
            //"&chroma=FFEEFF"+
            //"&fontsize=200"+
            //"&hh"+	//hide vdo ninja header
            //"&ee"+	//easy exit
            //"&cv"+	//clean viewer
            //"&hpb"+	//hide play button
            //"&nsb"+	//hide speaker button
            //"&nohub"+	//hide hangup button
            //"&hidehome"+	//hide vdo ninja home page
            //"&hidetranslate"+	//hides translate menu
            //"&darkmode"+	//
            //"&nocontrols"+	//hides video player controls
            //"&showlist=0"+	//show hidden guest list
            //"&js=https%3A%2F%2Frpxl.app%2Fscripts%2Fninjachat.js"+
</script>
