<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="-1"/>
    <meta name="msapplication-TileColor" content="#2e2e2e"/>
    <meta name="keywords" content="Gui Felix, Advertising, Visual Effects, Motion Graphics, Remote Pixels, vdo.ninja"/>
    <meta name="robots" content="index, follow"/>
    <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

    <link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">
    <link rel="mask-icon" href="icons/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="icons/favicon.ico">
    <meta name="color-scheme" content="light dark">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@200" rel="stylesheet" />

    <link rel="stylesheet" href="styles/clientstyle.css">
    <link rel="stylesheet" href="styles/styles.css">
    <link rel="stylesheet" href="styles/mobilestyle.css">

    <title>alpha.rpxl.app v3</title>
</head>

<body id="body">
    <!--iframes for vdo ninja-->
    <iframe class="viewersiframe hidden" id="viewersStream" allow="autoplay;screen-wake-lock;camera *;microphone *;display-capture;"></iframe>
    <iframe class="mainstreamiframe hidden" id="mainStream" allow="autoplay;screen-wake-lock;display-capture;"></iframe>   

    <!--canvas for drawing annotations-->
    <canvas id="annotationsCanvas" class="annotationsCanvas"></canvas>

    <!--Main interface-->
    <div id="mainWindow" class="hidden">
        <!--top menu bar-->
        <div id="topmenu" class="toolbar top">	
            <div style="width:20px"></div>
            <h3 id="sessionTitle">RPXL</h3>
            <div class="toolspacer"></div>           
            <div class="toolset">
                <a href="https://vdo.ninja" target="_blank" style="text-decoration: none">
                    <button class="botton buttonblue buttonWider" id="vdoninja">Powered by vdo.ninja</button>
                </a>
            </div>
        </div>
        <!--bottom menu bar-->
        <div id="bottomMenu" class="toolbar bottom">
            <div class="toolset">
                <button class="tool toolmoresettings" id="toolSettings" aria-expanded="false"><span class="material-symbols-outlined">settings</span></button>
            </div>
            <div class="toolset toolspacer">
                <button class="tool toolred disable" aria-expanded="false" id="toolMuteMicrophone"><span class="material-symbols-outlined">mic</span></button>
                <button class="tool disable" aria-expanded="false" id="toolMuteCamera" disabled><span class="material-symbols-outlined">photo_camera</span></button>
            </div>
            <div class="toolset" id="toolAnnotations">
                <button class="tool streamtool disable" aria-expanded="false" id="toolDraw" disabled><span class="material-symbols-outlined">format_ink_highlighter</span></button>
                <button class="tool streamtool toolmoresettings disable" aria-expanded="false" id="toolPalette" disabled><span class="material-symbols-outlined">palette</span></button>
                <button class="tool streamtool disable" aria-expanded="false" id="toolEraser" disabled><span class="material-symbols-outlined">ink_eraser_off</span></button>
            </div>
            <div class="toolspacer"></div>
            <div class="toolset"><button class="tool streamtool disable" aria-expanded="false" id="toolMuteStream" disabled><span class="material-symbols-outlined">volume_up</span></button>   
                <span class="volume streamtool"><input type="range" id="toolStreamVolume" value="80" min="0" max="100" disabled class="streamtool disable"></span>        
            </div>
        </div>
    </div>

    <div class="popupBG hidden" id="popupBG"></div>

    <!--enter session ID dialog-->
    <dialog open id="sessionDialog" class="centerhorizontal top">
        <div><h2>Enter a valid Session ID to continue</h2></div>
        <div><input type="text" maxlength="6" class="sessionID" id="sessionID" contenteditable="true" oninput="restrictInput(event)" style="text-transform:uppercase" autofocus autocomplete="off"></div>
        <div><h3>6 character code supplied by the host</h3></div>
        <div><button id="checkSession" class="botton buttonblue buttonWider">Continue</button></div>
    </dialog>

    <!--enter username, select camera and microphone dialog-->
    <dialog id="settingsDialog" class="toolpopup top middle hidden">
        <div id="camPreview">
            <span id="cameraFill" class="cameraFill"></span>
            <video id="camera" class="camera fadeout" autoplay playsinline poster=""></video>
            <span id="meterGraph" class="meterGraph">
                <span id="micmeter" class="meter"></span> 
            </span>
            <audio id="microphone" class="loginaudio" autoplay></audio>
        </div>
        <div class="table">
            <div>Name</div><div><input type="text" maxlength="25" class="textinput" id="name" placeholder="(Required)" contenteditable="true" autocomplete="off"></div>
            <div>Camera</div><div class="custom-select"><select contenteditable="true" id="cameraSource"><option value="">None</option></select></div>
            <div>Microphone</div><div class="custom-select"><select contenteditable="true" id="microphoneSource"><option value="" selected disabled>None</option></select></div>
        </div>
        <hr>
        <div>
            <button id="checkLogin" class="botton buttonblue buttonWider">Join live session</button>
        </div>
    </dialog>

    <!----- popup color menu ------>
    <dialog id="paletteDialog" class="toolpopup bottom middle hidden">
            <div>
                <span class="colorpot" value="black" aria-expanded="false" style="background-color: black;"></span>
                <span class="colorpot selectedcolorpot" value="white" aria-expanded="true" style="background-color: white;"></span>
                <span class="colorpot" value="cyan" aria-expanded="false" style="background-color: cyan;"></span>
                <span class="colorpot" value="magenta" aria-expanded="false" style="background-color: magenta;"></span>
                <span class="colorpot" value="yellow" aria-expanded="false" style="background-color: yellow;"></span>
            </div>
    </dialog>

    <!----- Permissions ------>
    <dialog id="permissionsDialog" class="toolpopup top middle hidden">
        <h2>Warning : Microphone or Camera permissions blocked</h2>
        <p>Please check your browser settings to allow access<br>to the microphone and camera for streaming.</p>
        <p>You will be able to mute them at any time.</p>
        <hr>
        <button id="permissionMicHelp" class="botton buttonblue buttonWider"> Click here for more information </button>
    </dialog>
    
    <!----- popup menu microphone mute ------>
    <dialog id="popupMicMuted" class="centerhorizontal hidden warning">
        <h2 style="color: var(--color-light-bg)">Warning : Your microphone is muted</h2>
    </dialog>

    <!----- popup menu microphone mute ------>
    <dialog id="popupCamMuted" class="centerhorizontal hidden notification">
        <h2>Your camera has been turned off</h2>
    </dialog>

    <!----- popup menu microphone mute ------>
    <dialog id="popupStreamMuted" class="centerhorizontal hidden notification">
        <h2>Incoming stream muted (You will still hear participants)</h2>
    </dialog>

</body>
</html>

<script src="scripts/github.js"></script>   <!-- check github issues for session ID -->
<script src="scripts/checkpermissions.js"></script>  <!-- check if mic and camera permissions are blocked and poulate dropdowns with values -->
<script src="scripts/avpreview.js"></script> <!-- preview streams as we select them (currrently mostly off) -->
<script src="scripts/cookies.js"></script>  <!-- check and store cookies -->
<script src="scripts/initui.js"></script>
<script src="scripts/initvdo.js"></script>
<script src="scripts/interface.js"></script>
<script src="scripts/annotations.js"></script>


<script lang="javascript">
var gitresults = [ ]; //array to hold the results we get back from github

localStorage.clear(); //clear local storage on load to avoid issues with old settings
sessionStorage.clear(); //clear session storage on load to avoid issues with old settings

//get the session id's for the past X days in github.js and then check the session ID against the github issues
getList(); //github.js
checkPermissions(); //checkpermissions.js

//checks if an url parameter supplied, if valid, skips the session ID screen goes straight ti user screen
function checkSessionURL (result) {
    //console.log("getlist result :",result);
    let query = location.search;
    let sessionIDURL = query.slice(1);
    let sessionIDUppercase = sessionIDURL.toUpperCase();
    let	sessionID = encodeURIComponent(sessionIDUppercase); 

    result.items.forEach(i=>{
        if (i.title == "SessionID" && i.author_association == "OWNER") { //every item we get back made by owner and has sessionID in the title
            const decodedBody = atob(i.body);   //decrypt and split
            const splitBody = decodedBody.split("&");
        
            gitresults.push (splitBody);

            if (splitBody[0] == sessionID) {  //check against the suplied URL, if it matches decode client name
                //check cookie data for username, camera and microphone
                checkCookie("username", "camera", "mic"); //cookies.js
                
                clientEncoded = splitBody[1];
                client = decodeURIComponent(clientEncoded); //decode the client name
                //fill in client name and session ID in the interface
                document.getElementById("sessionTitle").innerHTML = client + " Live session ("+sessionID+")";
                document.getElementById("sessionID").value = sessionID;
                //hide session dialog
                sessionDialog.classList.add("hidden");
                sessionDialog.close();
                //show user, camera and microphone dialog
                settingsDialog.classList.remove("hidden");
                settingsDialog.show();
                document.getElementById("name").focus();
                storeSelectedDevices(1,0,0)     //store session ID only
            } 
        }
    })
}

//submit session ID on enter or click, focus field, run checkEnteredSession() function
document.getElementById("sessionID").focus();
document.getElementById("checkSession").addEventListener("click", checkEnteredSession);
document.getElementById("sessionID").addEventListener("keypress", function(event) {
	if (event.key === "Enter") {
		event.preventDefault();
		document.getElementById("checkSession").click();
		}
	});

//if the session ID is 6 characters long then check it against the github issues, if valid then show the client login screen
function checkEnteredSession() {
    const sessionIDEntered = sessionID.value;
    const sessionIDEnteredUppercase = sessionIDEntered.toUpperCase();
    const sessionIDEnteredSanitized = encodeURIComponent(sessionIDEnteredUppercase);

    // Shake dialog if session ID incorrect
    function showError() {
        sessionDialog.style.animation = "shake 500ms";
        setTimeout(() => { sessionDialog.style.animation = "none"; }, 300);
        sessionID.value = "";
        sessionID.focus();
    }

    //check if there is a session ID and if it is 6 characters long
    if (!sessionIDEnteredSanitized || sessionIDEnteredSanitized.length !== 6) {
        showError();
        return;
    }
    
    const found = gitresults.find(([id]) => id === sessionIDEnteredSanitized); //compare sanitized ID to results we got from github using async getlist()

    if (found) { //if we found a match then show the user, camera and microphone dialog
        //check cookie data for username, camera and microphone
        storeSelectedDevices(1,0,0) //store session ID only
        checkCookie("username", "camera", "mic"); //cookies.js

        const clientEncoded = found[1];
        const client = decodeURIComponent(clientEncoded);
        document.getElementById("sessionTitle").innerHTML = client + " Live session ("+sessionIDEnteredSanitized+")";
        //hide the seeion dialog
        sessionDialog.close();
        sessionDialog.classList.add("hidden");
        //show user, camera and microphone dialog
        settingsDialog.classList.remove("hidden");
        settingsDialog.show();
        document.getElementById("name").focus();
    } else {
        showError();
    }
}

//User, camera and microphone dialogue window submit button and enter actions (run setupSession())
document.getElementById("checkLogin").addEventListener("click", setupSession);
document.getElementById("name").addEventListener("keypress", function(event) {
	if (event.key === "Enter") {
		event.preventDefault();        
		document.getElementById("checkLogin").click();
		}
	});

//check that the user has entered a name and selected a microphone, if yes then start the vdo ninja streams and change the interface
function setupSession() {
    const nameInput = document.getElementById("name");
    const micSelect = document.getElementById("microphoneSource");

    let username = document.getElementById("name").value;
    sanitizedUserName = encodeURIComponent(username); 
    //check if the username is empty or no microphone selected
    if (!sanitizedUserName) {
        animateAndFocus(nameInput);
        return;
    }
    if (micSelect.selectedIndex === 0) {
        animateAndFocus(microphoneSource);
        return;
    } 
    //flash error
    function animateAndFocus(element) {
        element.style.animation = "pulse 300ms";
        setTimeout(() => { element.style.animation = "none"; }, 300);
        element.focus();
    }

    //if the username is not empty then stop streams so not to conflict with the vdo ninja ones
    //stopAllMediaStreams();

    //hide the user, camera and microphone dialog
    settingsDialog.close();     
    document.getElementById("settingsDialog").classList.add("hidden");    
    document.getElementById("mainWindow").classList.remove("hidden");      
    document.body.style.backgroundImage = "none";

    //reset settings dialog to be a settings dialog not a login dialog
    document.getElementById("settingsDialog").classList.remove("top", "middle");        
    document.getElementById("settingsDialog").classList.add("toolpopup", "bottom", "left");
    document.getElementById("camPreview").style.display = "none";
    document.getElementById("checkLogin").innerHTML = "Change settings";
    checkLogin.removeEventListener("click", setupSession);    // Remove start session listener and add settings change listener

    checkLogin.addEventListener("click",() => {
        //deactivateTools();
        //storeSelectedDevices(); 
        //reactivateTools();
        viewerStream() ; //from initvdo.js
    });

    viewerStream(); //from initvdo.js
    setTimeout(function(){   
        viewMainStream();//from initvdo.js
    },1000);
}
</script>
