<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="-1" />
    <meta name="msapplication-TileColor" content="#2e2e2e" />
    <meta name="description" content="Serverless web app that allows you transmit to a high quality stream to clients to view and comment on using WEBRTC and VDO.NINJA. Communication between clients is handled using low latency and very little bandwidth, dedicating as much bandwidth to the main strea, often the feed from an edit machine. Also, we think Capybara's are awesome though that might not be relevant in this case.">
    <meta name="keywords" content="Gui Felix, Advertising, Visual Effects, Motion Graphics, Remote Pixels, vdo.ninja" />
    <meta name="robots" content="index, follow" />
    <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <link rel="apple-touch-icon" sizes="180x180" href="../icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../icons/favicon-16x16.png">
    <link rel="mask-icon" href="../icons/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="../icons/favicon.ico">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@200" rel="stylesheet" />

    <link rel="stylesheet" href="../styles/streamstyle.css">
    <link rel="stylesheet" href="../styles/styles.css">

    <title>alpha.rpxl.app v3.5 | Stream (beta)</title>
</head>

<body id="body">
    <!--iframes for vdo ninja-->
    <div id="viewerMobile" class="">
        <iframe class="viewersiframe hidden" id="viewersStream" allow="autoplay;camera;microphone;fullscreen;picture-in-picture;display-capture;midi;screen-wake-lock;"></iframe>
    </div>

    <div class="mainZoom hidden" id="zoomdiv">
        <iframe class="mainstreamiframe" id="mainStream" allow="autoplay;camera;microphone;fullscreen;picture-in-picture;display-capture;midi;screen-wake-lock;"></iframe>
        <canvas id="annotationsCanvas" class="annotationsCanvas"></canvas>
    </div>

    <!------------------------Main interface------------------>
    <div id="mainWindow" class="hidden ">
        <!--top menu bar-->
        <div id="topmenu" class="toolbar top">
            <div class="toolbar-section left">
                <div class="toolset">
                    <button class="tool toolmoresettings" id="toolShare" aria-expanded="false" role="button"><span class="material-symbols-outlined">ios_share</span></button>
                </div>
            </div>
            <div class="toolbar-section center">
                <div><h2 id="sessionName" class="centervertical">RPXL</h2></div>
            </div>
            <div class="toolbar-section right">
                <div class="toolset">
                    <button class="tool toolred toolmoresettings" id="toolQuit" aria-expanded="false" role="button"><span class="material-symbols-outlined">mode_off_on</span></button>
                </div>
            </div>
        </div>
        <!--bottom menu bar-->
        <div id="bottomMenu" class="toolbar bottom">
            <div class="toolbar-section left">
                <div class="toolset">
                    <button class="tool toolmoresettings" id="toolSettings" aria-expanded="false" role="button"><span class="material-symbols-outlined">settings</span></button>
                </div>
                <div class="toolset">
                    <button class="tool toolred disable" aria-expanded="false" id="toolMuteMicrophone" disabled role="button"><span class="material-symbols-outlined">mic</span></button>
                    <button class="tool disable" aria-expanded="false" id="toolMuteCamera" disabled role="button"><span class="material-symbols-outlined">photo_camera</span></button>
                </div>
            </div>
            <div class="toolbar-section center">
                <div class="toolset">
                    <button class="tool streamtool disable" aria-expanded="false" id="toolDraw" disabled role="button"><span class="material-symbols-outlined">format_ink_highlighter</span></button>
                    <button class="tool streamtool toolmoresettings disable" aria-expanded="false" id="toolPalette" disabled role="button"><span class="material-symbols-outlined">palette</span></button>
                    <button class="tool streamtool disable" aria-expanded="false" id="toolEraser" disabled role="button"><span class="material-symbols-outlined">ink_eraser_off</span></button>
                </div>
            </div>
            <div class="toolbar-section right">
                <div class="toolset toolspacer">
                    <button class="tool toolmoresettings disable" aria-expanded="false" id="toolFiles" disabled role="button"><span class="material-symbols-outlined">folder</span></button>
                </div>
                <div class="toolset">
                    <button class="tool streamtool red disable" aria-expanded="false" id="toolBlindStream" disabled role="button"><span class="material-symbols-outlined">movie_off</span></button>
                    <button class="tool streamtool disable" aria-expanded="false" id="toolMuteStream" disabled role="button"><span class="material-symbols-outlined">volume_up</span></button>
                    <span class="volume streamtool" role="button"><input type="range" id="toolStreamVolume" value="0" min="0" max="100" disabled class="disable streamtool" /></span>
                </div>
            </div>
        </div>
        <div>
            <a href=https://vdo.ninja target="_blank" class="copyCredit">powered by vdo.ninja</a>
        </div>
    </div>

    <div class="popupBG hidden" id="popupBG"></div>

    <!--Setup screen, also used as setting panel later-->
    <dialog open id="settingsDialog" class="toolpopup top middle" style="min-width:640px">
        <div class="" id="settingsDialogTitleCreate" style="text-align: left;">
            <h2 id="createHeadingSession" style="padding-bottom: 10px;">Create live session</h2><a href="help.html" target="_blank" class="helpicon">
            <span class="material-symbols-outlined">help</span></a>
        </div>
        <div class="table" id="settingsDialogProjectID">
            <div>Project</div>
            <div><input type="text" class="textinput" maxlenght="40" id="project" name="clientName" placeholder="(Optional)" contenteditable="true">
                <span class="toolset" id="historyButton"><button class="tool toolmoresettings" id="toolHistory" aria-expanded="false" role="button">
                    <span class="material-symbols-outlined">history</span></button>
                </span>
            </div>
        </div>
        <!-- <div style="width:100%"><hr></div> -->
        <div class="table" id="settingsDialogSessionSettings">
            <div>Resolution</div><div class="radioset" role="radiogroup" aria-labelledby="resolution" role="button"><label><input type="radio" name="resolution" id="res1080P" value="0">1080P</label><label><input type="radio" name="resolution" id="res720P" checked value="1">720P</label></div>
            <div>Quality</div><div class="radioset" role="radiogroup" aria-labelledby="quality" role="button"><label><input type="radio" name="quality" id="qualityHigh" value="16000">High</label><label><input type="radio" name="quality" id="qualityMed" value="8000" checked>Med</label><label><input type="radio" name="quality" id="qualityLow" value="4000">Low</label></div>
            <div>Video source</div><div class="custom-select"><select contenteditable="true" id="videoSource"><option value="">None</option></select></div>
            <div>Audio source</div><div class="custom-select"><select contenteditable="true" id="audioSource"><option value="">None</option></select> </div>
            <div style="grid-column: 3 / span 2; grid-row: 1 / span 4; position:relative; top:3px;" id="settingsDialogVideoAudioPreview"><video id="video" class="videosource" autoplay playsinline poster="" muted></video><span id="meterGraph" class="meterGraph"><span id="audiometer" class="meter"></span></div>
        </div>
        <div style="width:100%; margin:10px 0px;"><hr></div>
        <div class="table collapsed" id="moresettings">
            <div style="grid-column: 1 / span 2;"><h2 id="createOptional">Optional user settings</h2></div>
            <div>User</div><div><input type="text" maxlength="25" class="textinput" id="name" name="username" placeholder="(Optional)" contenteditable="true" autocomplete="off"></div>
            <div>Camera</div><div class="custom-select"><select contenteditable="true" id="cameraSource"><option value="">None</option></select></div>
            <div>Microphone</div><div class="custom-select"><select contenteditable="true" id="microphoneSource"><option value="">None</option></select></div>
            <div id="settingsDialogCameraMicPreview" style="grid-column: 3 / span 2; grid-row: 1 / span 4;"><video id="camera" class="camera" autoplay playsinline poster="" muted></video></span><span id="meterGraph" class="meterGraph"><span id="micmeter" class="meter"></span></span></div>
        </div>
        <div id="moresettingsHR" class="hidden" style="width:100%; margin:10px 0px;"></div>
        <div id="settingsDialogButtons" style="position: relative; width: 100%; display: inline-flex; justify-content: space-between; align-items: center;">
            <div><button id="buttonMoreSettings" class="buttonmoresettings" aria-expanded="false">More setings</button></div>
            <div><button id="startSessionButton" class="botton buttonblue buttonWider">Start session</button></div>
        </div>
    </dialog>

    <!----- history dialog ------>
    <div class="popupBG hidden" id="popupHistoryBG"></div>
    <dialog id="historyDialog" class="toolpopup top right hidden">
    </dialog>

    <!----- share dialog ------>
    <dialog id="shareDialog" class="toolpopup top left share hidden">
        <button class="link" id="copyMainLink"><h2>Main share link</h2><br> Allows full voice and video communications and live annotations </button>
        <button class="link" id="copyQuickLink"><h2>Quick share link</h2><br> No voice or video communications, streamer and clients can annotate </button>
        <button class="link" id="copyOBSLink"><h2>OBS source link</h2><br> Main stream URL for input to OBS browser source </button>
    </dialog>

    <!----- quit dialog ------>
    <dialog id="quitDialog" class="confirmpopup hidden">
        <button id="confirmQuit" class="button toolred buttonWider"> Confirm quit </button>
    </dialog>

    <!----- color menu ------>
    <dialog id="paletteDialog" class="toolpopup bottom middle hidden">
        <span class="colorpot" role="button" value="black" aria-expanded="false"
            style="background-color: black;"></span><span class="colorpot selectedcolorpot" role="button" value="white"
            aria-expanded="true" style="background-color: white;"></span><span class="colorpot" role="button"
            value="cyan" aria-expanded="false" style="background-color: cyan;"></span><span class="colorpot"
            role="button" value="magenta" aria-expanded="false" style="background-color: magenta;"></span><span
            class="colorpot" role="button" value="yellow" aria-expanded="false"
            style="background-color: yellow;"></span>
    </dialog>

    <!-- mobile browser -->
    <dialog id="mobileDialog" class="toolpopup top middle hidden" style="width:600px!important; top:70px;">
        <span class="material-symbols-outlined" style="font-size:125px">error</span><br>
        <h2>Warning : Mobile browser detected</h2>
        <p>Currently, streaming is desktop only.</p>
        <p>Mobile streaming might work but your mileage may vary. This only affects the streamer, guests can connect via desktop or mobile device.</p>
        <hr>
        <button id="mobileDismiss" class="botton buttonblue buttonWider"> Try anyway </button>
    </dialog>

    <!----- Permissions ------>
    <dialog id="permissionsDialogStream" class="toolpopup top middle hidden" style="width:410px!important;">
        <span class="material-symbols-outlined" style="font-size:125px">error</span><br>
        <h2>Warning : Video or audio permissions blocked</h2>
        <p>Please check your browser settings to allow<br>access to your video and audio sources.</p>
        <p>You will be able to disable them at any time.</p>
        <hr>
        <a href="https://www.google.com/search?q=browser+miicrophone+and+camera+permissions+setup+for+desktop+and+mobile&rlz=1C5CHFA_enCH1148CH1149&oq=browser+miicrophone+and+camera+permissions+setup+for+desktop+and+mobile&gs_lcrp=EgZjaHJvbWUyBggAEEUYOdIBCTIxMDk0ajBqN6gCCLACAfEFhqUbtfZyAjs&sourceid=chrome&ie=UTF-8" target="_new"><button id="permissionMicHelp" class="botton buttonblue buttonWider"> Click here for more info</button></a>
    </dialog>

    <!----- popup menu microphone mute ------>
    <dialog id="popupMicMuted" class="toolpopup top middle hidden warning">
        <h2 style="color: var(--color-light-bg)">Warning : Your microphone is muted</h2>
    </dialog>

    <!----- popup menu microphone mute ------>
    <dialog id="popupCamMuted" class="toolpopup top middle hidden notification">
        <h2>Your camera has been turned off</h2>
    </dialog>

    <!----- stream mute ------>
    <dialog id="popupStreamMuted" class="toolpopup top middle hidden notification">
        <h2>Broadcast stream audio muted locally.</h2><br>Participants will still hear you and the stream.
    </dialog>

    <!----- Copied links to clipboard ------>
    <dialog id="popupClipboard" class="toolpopup top middle hidden notification">
        <h2>Link copied to clipboard</h2>
    </dialog>

    <!----- popup stream zoomed popup------>
    <div id="zoom-popup" class="zoom-popup">Stream zoomed</div>

</body>
</html>

<script src="../scripts/deviceselect.js"></script>
<script src="../scripts/initui.js"></script>
<script src="../scripts/initvdo.js"></script>
<script src="../scripts/interface.js"></script>
<script src="../scripts/annotations.js"></script>

<script type="text/javascript">
    const APP_NS = 'host-Alpha-RPXL';
    const devURL = window.location.origin;
    let historyBGAttached = false;

    //check if mobile device and warn user
    const mobileDialog = document.getElementById("mobileDialog");
    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

    if (isMobile) {
        mobileDialog.classList.remove("hidden");
        mobileDialog.show();
        mobileDismiss.addEventListener("pointerdown", () => {
            mobileDialog.classList.add("hidden");
            mobileDialog.close();
        });
        console.log("User is on a mobile device.");
    }

    sessionStorage.clear(); //clear session storage on load to avoid issues with old settings
    randomBG(); //initui.js pics a random background image from initui.js

    //pretty date in history dialog
    function formatDateISO(dateString) {
        const d = new Date(dateString);
        return (
            d.getFullYear() + "-" +
            String(d.getMonth() + 1).padStart(2, "0") + "-" +
            String(d.getDate()).padStart(2, "0") + " " +
            String(d.getHours()).padStart(2, "0") + ":" +
            String(d.getMinutes()).padStart(2, "0")
        );
    }

    function loadHistoryIntoDialog() {
        const sessionsJSON = localStorage.getItem(APP_NS);
        if (!sessionsJSON) return;

        const sessions = JSON.parse(sessionsJSON);
        const dialog = document.getElementById("historyDialog");

        openDialog(historyDialog, toolHistory);
        document.getElementById("popupHistoryBG").classList.remove("hidden");

        // Attach background listener ONCE
        if (!historyBGAttached) {
            window.addEventListener("pointerdown", (e) => {
                if (e.target.matches("#popupHistoryBG")) {
                    closeDialog(openModal, openIcon);
                    document.getElementById("popupHistoryBG").classList.add("hidden");
                }
            });
            historyBGAttached = true;
        }

        dialog.innerHTML = `
        <span>Loading previous session settings will allow use of existing invite link</span><br>
        <hr>`; // reset

        sessions.forEach(entry => {
            const project = decodeURIComponent(entry.projectName) || "Unnamed project";
            const formattedDate = formatDateISO(entry.createdAt);

            const btn = document.createElement("button");
            btn.className = "link historyEntry";
            btn.dataset.sessionId = entry.sessionID;

            btn.innerHTML = `
            <h2>${project}</h2>
            <span class="date">${formattedDate}</span>
        `;

            btn.addEventListener("click", async () => {
                restoreSessionFromHistory(entry);
                //console.log(`Restored session from history: ${entry.sessionID}`);
            });

            dialog.appendChild(btn);
        });
    }

    async function restoreSessionFromHistory(entry) {
        // Restore sessionID + projectName only here
        sessionStorage.setItem("sessionID", entry.sessionID);
        console.log(`Restored sessionID: ${entry.sessionID} from history`);

        const projectInput = document.getElementById("project");
        projectInput.value = decodeURIComponent(entry.projectName) === "Unnamed project"
            ? ""
            : decodeURIComponent(entry.projectName);

        // Restore all *other* UI settings
        await restoreSettingsHost(entry); //from initui.js

        closeDialog(openModal, openIcon);
        document.getElementById("popupHistoryBG").classList.add("hidden");
    }

    //generate random SID
    function generateSessionID(len = 20) {
        const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        const charCount = chars.length;
        const max = 256 - (256 % charCount);

        let id = "";
        const buf = new Uint8Array(len * 2);

        crypto.getRandomValues(buf);

        for (let i = 0; i < buf.length && id.length < len; i++) {
            const n = buf[i];
            if (n < max) id += chars[n % charCount];
        }
        return id;
    }

    sessionStorage.setItem("sessionID", generateSessionID());  //create session ID and store in session storage

    //more settings menu on create dialogue flyout
    buttonMoreSettings.addEventListener("pointerdown", () => {
        const isExpanded = buttonMoreSettings.getAttribute("aria-expanded") === "true";
        buttonMoreSettings.setAttribute("aria-expanded", isExpanded ? "false" : "true");
        buttonMoreSettings.innerHTML = isExpanded ? "More settings" : "Less settings";
        document.getElementById("moresettings").classList.toggle("collapsed");
        document.getElementById("moresettingsHR").classList.toggle("hidden");
    });

    document.getElementById('startSessionButton').addEventListener('pointerdown', startSession);

    window.addEventListener("DOMContentLoaded", () => {
        getDevices().then(() => {

            // Only run this AFTER device options exist
            document.getElementById("project").value = ""; //clear project name on load
            const sessionsJSON = localStorage.getItem(APP_NS);
            if (!sessionsJSON) return;

            const sessions = JSON.parse(sessionsJSON);
            if (!sessions.length) return;

            const last = sessions[0];   // newest entry (we always unshift)
            console.log(`Auto-restoring last session settings from localStorage`);
            restoreSettingsHost(last);   // restore everything except session + project

            // Attach event listeners (safe now)
            [mainAudioSelect, userAudioSelect, mainVideoSelect, userVideoSelect].forEach(sel => {
                sel.addEventListener('change', handleSelectionChange);
            });
        });
    });

    //share button (main, quick and obs)
    function setupShareButton(buttonId, sessionID, urlFormatter) {
        const btn = document.getElementById(buttonId);
        if (!btn) return;

        btn.addEventListener("pointerdown", () => {
            const value = sessionStorage.getItem(sessionID);
            if (!value) return;

            const url = urlFormatter(value);
            console.log(`Copying to clipboard: ${url}`);
            navigator.clipboard.writeText(url).then(() => {
                closeDialog(shareDialog, toolShare);    //close share dialog
                popupClipboard.classList.remove("hidden");        //show copied to clipboard message
                popupClipboard.show();

                setTimeout(function () {         //hide copied to clipbaord message after 3 seconds
                    popupClipboard.classList.add("hidden");
                    popupClipboard.close();
                }, 3000);
            });
        });
    }

    setupShareButton("copyMainLink", "sessionID", value => `${devURL}/?SID=${value}`);
    setupShareButton("copyQuickLink", "sessionID", value => `${devURL}/qv/?SID=${value}`);
    setupShareButton("copyOBSLink", "sessionID", value => `${devURL}/vdo/?view=Stream${value}&solo&room=RPXL${value}`);

    confirmQuit.addEventListener("pointerdown", function () {
        //stop current streams make sure video and audio objects are hidden
        mainStream.contentWindow.postMessage({
            "hangup": true
        }, '*');
        viewersStream.contentWindow.postMessage({
            "hangup": true
        }, '*');
        document.getElementById("mainStream").src = "";
        document.getElementById("viewersStream").src = "";

        location.reload();
    });

    function startSession() {
        console.log("init session start")
        //stuff to run once and once only when starting session
        const sessionID = sessionStorage.getItem("sessionID");
        const timestamp = new Date().toISOString();
        const sanitizedProject = encodeURIComponent(document.getElementById("project").value.trim());
        const resolution = getCheckedRadioValue("resolution"); //from initui.js
        const quality = getCheckedRadioValue("quality"); //from initui.js
        const videoSource = document.getElementById("videoSource").selectedOptions[0].value;
        const audioSource = document.getElementById("audioSource").selectedOptions[0].value;
        const sanitizedUserName = encodeURIComponent(document.getElementById("name").value.trim());
        const cameraSource = document.getElementById("cameraSource").selectedOptions[0].value;
        const microphoneSource = document.getElementById("microphoneSource").selectedOptions[0].value;

        const entry = {
            sessionID: sessionID || "",
            createdAt: timestamp || "",
            projectName: sanitizedProject || "",
            resolution: resolution || "",
            quality: quality || "",
            videoSource: videoSource || "",
            audioSource: audioSource || "",
            userName: sanitizedUserName || "",
            cameraSource: cameraSource || "",
            microphoneSource: microphoneSource || ""
        };

        const sessionsJSON = localStorage.getItem(APP_NS);
        let sessions = sessionsJSON ? JSON.parse(sessionsJSON) : [];

        sessions.unshift(entry);
        sessions = sessions.slice(0, 5);

        localStorage.setItem(APP_NS, JSON.stringify(sessions)); //store session settings in local storage for history

        navigator.clipboard.writeText(`${devURL}/qv/?SID=${sessionID}`);         //Set Session Title & Copy Session Quick Link to Clipboard

        //hide stream settings creation dialog
        sessionName.innerHTML = decodeURIComponent(sanitizedProject || "Unnamed project");
        settingsDialog.close();

        document.body.style.backgroundImage = "none";

        const numberArray = Array.from({ length: 43 }, (_, i) => String(i).padStart(3, '0'));
        const randomNum = numberArray[Math.floor(Math.random() * numberArray.length)];
        var avatar = `${randomNum}.png`;
        sessionStorage.setItem("avatar", avatar);

        stopAll();

        //Change create dialog layout for settings to re-use it
        ["settingsDialog", "historyButton", "settingsDialogCameraMicPreview", "buttonMoreSettings", "settingsDialogVideoAudioPreview"].forEach(id => {
            document.getElementById(id).classList.add("hidden");
        });
        settingsDialogProjectID.style.width = "200px";
        project.style.width = "200px";
        moresettingsHR.classList.remove("hidden");
        settingsDialog.classList.remove("middle", "top", "min-width");
        settingsDialog.style.minWidth = "fit-content";
        settingsDialog.classList.add("toolpopup", "bottom", "left");
        createHeadingSession.innerHTML = "Session settings";
        settingsDialogSessionSettings.style.gridTemplateColumns = "110px 200px";
        createOptional.innerHTML = "User settings";
        moresettings.classList.remove("collapsed", "hidden");
        settingsDialogButtons.style.justifyContent = "center";
        startSessionButton.innerHTML = "Change settings";

        startSessionButton.removeEventListener("pointerdown", startSession);    // Remove start session listener and add settings change listener

        window.addEventListener("wheel", onWheel, { passive: false });
        window.addEventListener("pointerdown", onMouseDown);
        window.addEventListener("pointermove", onMouseMove);
        window.addEventListener("pointerup", onMouseUp);

        startSessionButton.addEventListener("pointerdown", () => {
            viewerStream(0,1);//from initvdo.js
            setTimeout(function () {
                startMainStream();//from initvdo.js
            }, 500);
        });

        mainWindow.classList.remove("hidden");

        viewerStream(1);//from initvdo.js
        setTimeout(function () {
            startMainStream(1);//from initvdo.js
        }, 500);
    }
</Script>