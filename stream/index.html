<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="Pragma" content="no-cache"/>
    <meta http-equiv="Expires" content="-1"/>
    <meta name="msapplication-TileColor" content="#2e2e2e"/>
    <meta name="description" content="Serverless web app that allows you transmit to a high quality stream to clients to view and comment on using WEBRTC and VDO.NINJA. Communication between clients is handled using low latency and very little bandwidth, dedicating as much bandwidth to the main strea, often the feed from an edit machine. Also, we think Capybara's are awesome though that might not be relevant in this case.">
    <meta name="keywords" content="Gui Felix, Advertising, Visual Effects, Motion Graphics, Remote Pixels, vdo.ninja"/>
    <meta name="robots" content="index, follow"/>
    <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

    <link rel="apple-touch-icon" sizes="180x180" href="../icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../icons/favicon-16x16.png">
    <link rel="mask-icon" href="../icons/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="../icons/favicon.ico">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@200" rel="stylesheet" />

    <link rel="stylesheet" href="../styles/streamstyle.css">
    <link rel="stylesheet" href="../styles/styles.css">
    
    <title>alpha.rpxl.app v3 | Stream</title>
</head>

<body>
    <!--iframes for vdo ninja-->   
    <iframe class="viewersiframe hidden" id="viewersStream" allow="autoplay;screen-wake-lock;camera *;microphone *;display-capture;encrypted-media;sync-xhr;usb;web-share;"></iframe>
        <div class="mainZoom" id="zoomdiv">
        <iframe class="mainstreamiframe hidden" id="mainStream" allow="autoplay;screen-wake-lock;display-capture;"></iframe>   
        <canvas id="annotationsCanvas" class="annotationsCanvas"></canvas>
    </div>

    <!------------------------Main interface------------------>
    <div id="mainWindow" class="hidden ">
        <!--top menu bar-->
        <div id="topmenu" class="toolbar top">	    
            <div class="toolset">
                <button class="tool toolmoresettings" id="toolShare" aria-expanded="false"><span class="material-symbols-outlined">ios_share</span></button>
            </div>
            <div>
                <h2 id="sessionName" class="centervertical">RPXL</h2>
            </div>
            <div class="toolset">
                <button class="tool toolred toolmoresettings" id="toolQuit" aria-expanded="false"><span class="material-symbols-outlined">mode_off_on</span></button>
            </div>
        </div>
        <!--bottom menu bar-->
        <div id="bottomMenu" class="toolbar bottom">
            <!--settings menu-->
            <div class="toolset">
                <button class="tool toolmoresettings" id="toolSettings" aria-expanded="false"><span class="material-symbols-outlined">settings</span></button>
            </div>
            <!--mute camera and microphone-->
            <div class="toolset toolspacer">
                <button class="tool toolred disable" aria-expanded="false" id="toolMuteMicrophone" disabled><span class="material-symbols-outlined">mic</span></button>
                <button class="tool toolred disable" aria-expanded="false" id="toolMuteCamera" disabled><span class="material-symbols-outlined">photo_camera</span></button>
            </div>
            <!--annotations-->
            <div class="toolset toolspacer">
                <button class="tool streamtool disable" aria-expanded="false" id="toolDraw" disabled><span class="material-symbols-outlined">format_ink_highlighter</span></button>
                <button class="tool streamtool toolmoresettings disable" aria-expanded="false" id="toolPalette" disabled><span class="material-symbols-outlined">palette</span></button>
                <button class="tool streamtool disable" aria-expanded="false" id="toolEraser" disabled><span class="material-symbols-outlined">ink_eraser_off</span></button>
            </div>
            <!--Mute main stream-->
            <div class="toolset ">
                <button class="tool streamtool red disable" aria-expanded="false" id="toolBlindStream" disabled><span class="material-symbols-outlined">movie_off</span></button> 
                <button class="tool streamtool disable" aria-expanded="false" id="toolMuteStream" disabled><span class="material-symbols-outlined">volume_up</span></button>   
                <span class="volume streamtool" ><input type="range" id="toolStreamVolume" value="0" min="0" max="100" disabled class="disable"/></span>    
            </div>
        </div>

    </div>    

    <div class="popupBG hidden" id="popupBG"></div>

    <!--Setup screen, also used as setting panel later-->
    <dialog open id="settingsDialog" class="toolpopup top middle">
        <div class="table" id="settingsDialogTitleCreate">
            <div style="grid-column: 1 / span 4;"><h2 id="createHeadingSession" style="height:30px; top:-5px;">Create live session</h2><a href="help.html" target="_blank" class="helpicon"><span class="material-symbols-outlined">help</span></a></div>
        </div>
        <div class="table" id="settingsDialogProjectID">
            <div style="grid-column: 1 / span 3;">Project  &nbsp;<input type="text" maxlength="26" class="textinput" id="project" name="clientName" placeholder="(Optional)" contenteditable="true" style="width:320px;"></div>
            <div>SID &nbsp;<input type="text" maxlength="6" class="textinput" id="sessionID" name="sessionID" placeholder="(Required)" contenteditable="true" autocomplete="off" style="text-transform:uppercase; width:160px; background-color: light-dark(var(--color-light-white), var(--color-mid-grey));  color: light-dark(var(--color-light-grey), var(--color-light-grey));" oninput="restrictInput(event)"></input><span class="material-symbols-outlined refreshicon" id="generateSessionIcon">autorenew</span></div>
            <div style="grid-column: 1 / span 4;"><hr></div>
        </div>
        <div class="table" id="settingsDialogSessionSettings">
            <div>Resolution</div><div class="radioset" role="radiogroup" aria-labelledby="resolution"><label class="disable"><input type="radio" name="resolution" id="res4k" disabled value="&width=3840&height=2160">4K</label><label><input type="radio" name="resolution" id="res1080P" value="0">1080P</label><label><input type="radio" name="resolution" id="res720P"checked value="1">720P</label></div>
            <div>Quality</div><div class="radioset" role="radiogroup" aria-labelledby="quality"><label><input type="radio" name="quality" id="qualityHigh" value="16000">High</label><label><input type="radio" name="quality" id="qualityMed" value="8000" checked>Med</label><label><input type="radio" name="quality" id="qualityLow" value="4000">Low</label></div>
            <div>Video source</div><div class="custom-select"><select contenteditable="true" id="videoSource"><option value="">None</option></select></div>
            <div>Audio source</div><div class="custom-select"><select contenteditable="true" id="audioSource"><option value="">None</option></select> </div>
            <div style="grid-column: 3 / span 2; grid-row: 1 / span 4;" id="settingsDialogVideoAudioPreview"><video id="video" class="videosource" autoplay playsinline poster="" muted></video><span id="meterGraph" class="meterGraph"><span id="audiometer" class="meter"></span></div> 
        </div>
        <div class="table collapsed hidden" id="settingsDialogTitleOptional">
            <div style="grid-column: 1 / span 4;"><hr></div>
        </div>
        <div class="table hidden collapsed"  id="moresettings">
            <div style="grid-column: 1 / span 2;"><h2 id="createOptional" >Optional user settings<br></h2></div>
            <div>Username</div><div><input type="text" maxlength="25" class="textinput" id="name" name="username" placeholder="(Optional)" contenteditable="true" autocomplete="off"></div>
            <div>Camera</div><div class="custom-select"><select contenteditable="true" id="cameraSource"><option value="">None</option></select></div>
            <div>Microphone</div><div class="custom-select"><select contenteditable="true" id="microphoneSource"><option value="">None</option></select></div>                     
            <div id="settingsDialogCameraMicPreview" style="grid-column: 3 / span 2; grid-row: 1 / span 4;"><video id="camera" class="camera" autoplay playsinline poster="" muted></video></span><span id="meterGraph" class="meterGraph"><span id="micmeter" class="meter"></span></span></div> 
        </div>
        <div style="width:100%"><hr></div>
        <div id="settingsDialogButtons" style="position: relative; width: 100%; display: inline-flex; justify-content: space-between; align-items: center;">
            <div><button id="buttonMoreSettings" class="buttonmoresettings" aria-expanded="false">More setings</button></div>
            <div>&nbsp; </div>
            <div><button id="startSessionButton" class="botton buttonblue buttonWider">Start session</button></div>
        </div>
    </dialog>

    <!----- share dialog ------>
    <dialog id="shareDialog" class="toolpopup top left share hidden">
        <button class="link" id="copyMainLink"><h2>Main share link</h2><br>Copy Main share link to clipboard <br> Allows full voice and video communications and live annotations</button>
        <button class="link" id="copyQuickLink"><h2>Quick share link</h2><br>Copy Quick share link to clipboard <br> No voice or video communications, only presenter can annotate</button>
    </dialog>

    <!----- quit dialog ------>
    <dialog id="quitDialog" class="confirmpopup hidden" style="padding:0px; margin:0px; left:auto; width:263px">
        <button id="confirmQuit" class="botton toolred buttonWider"> Confirm quit </button>
    </dialog>

    <!----- color menu ------>
    <dialog id="paletteDialog" class="toolpopup bottom middle hidden">
        <span class="colorpot" value="black" aria-expanded="false" style="background-color: black;"></span>
        <span class="colorpot selectedcolorpot" value="white" aria-expanded="true" style="background-color: white;"></span>
        <span class="colorpot" value="cyan" aria-expanded="false" style="background-color: cyan;"></span>
        <span class="colorpot" value="magenta" aria-expanded="false" style="background-color: magenta;"></span>
        <span class="colorpot" value="yellow" aria-expanded="false" style="background-color: yellow;"></span>
    </dialog>

    <!----- Permissions ------>
    <dialog id="permissionsDialog" class="toolpopup top middle hidden">
        <h2>Warning : Microphone or Camera permissions blocked</h2>
        <p>Please check your browser settings to allow access<br>to the microphone and camera for streaming.</p>
        <p>You will be able to mute them at any time.</p>
        <hr>
        <button id="permissionMicHelp" class="botton buttonblue buttonWider"> Click here for more info </button>
    </dialog>
    
    <!----- popup menu microphone mute ------>
    <dialog id="popupMicMuted" class="toolpopup top middle hidden warning">
        <h2 style="color: var(--color-light-bg)">Warning : Your microphone is muted</h2>
    </dialog>

    <!----- popup menu microphone mute ------>
    <dialog id="popupCamMuted" class="toolpopup top middle hidden notification">
        <h2>Your camera has been turned off</h2>
    </dialog>

    <!----- stream mute ------>
    <dialog id="popupStreamMuted" class="toolpopup top middle hidden notification">
        <h2>Broadcast stream audio muted locally.</h2><br>Participants will still hear you and the stream.
    </dialog>

    <!----- Copied links to clipboard ------>
    <dialog id="popupClipboard" class="toolpopup top middle hidden notification">
        <h2>Link copied to clipboard</h2>
    </dialog>
</body>
</html>

<script src="../scripts/deviceselect.js"></script>
<script src="../scripts/cookies.js"></script> <!-- check and store cookies -->
<script src="../scripts/initui.js"></script>
<script src="../scripts/interface.js"></script>
<script src="../scripts/initvdo.js"></script>
<script src="../scripts/annotations.js"></script>
<script src="../scripts/github.js"></script>  <!-- add github issues for session ID and Project name (to cheap to have my own DB server)-->

<script type="text/javascript"> 
localStorage.clear(); //clear local storage on load to avoid issues with old settings
sessionStorage.clear(); //clear session storage on load to avoid issues with old settings

//toolbar code for stream page only, not shared anywhere else
//share and quit menu, blind stream tool
copyMainLink.addEventListener("click", () => {
    copyToClipboard("https://alpha.rpxl.app/?" + sessionID.value);
});

copyQuickLink.addEventListener("click", () => {
    copyToClipboard("https://alpha.rpxl.app/qv/?" + sessionID.value);
});

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        closeDialog(shareDialog, toolShare);    //close share dialog

        popupClipboard.classList.remove("hidden");        //show copied to clipboard message
        popupClipboard.show();

        setTimeout ( function () {         //hide copied to clipbaord message after 3 seconds
            popupClipboard.classList.add("hidden");
            popupClipboard.close();
        }, 3000);
    });
}

confirmQuit.addEventListener("click", function() { 
    //stop current streams make sure video and audio objects are hidden
    mainStream.contentWindow.postMessage({
        "hangup": true
    }, '*');
    viewersStream.contentWindow.postMessage({
        "hangup": true
    }, '*');
    document.getElementById("mainStream").src = "";
    document.getElementById("viewersStream").src = "";
    
    location.reload();
});

document.getElementById("startSessionButton").addEventListener("click", checkSessionID);

//more settings menu on create dialogue flyout
buttonMoreSettings.addEventListener("click", () => {
    const isExpanded = buttonMoreSettings.getAttribute("aria-expanded") === "true";
    buttonMoreSettings.setAttribute("aria-expanded", isExpanded ? "false" : "true");
    buttonMoreSettings.innerHTML = isExpanded ? "More settings" : "Less settings";
    settingsDialogTitleOptional.classList.toggle( "collapsed");
    settingsDialogTitleOptional.classList.toggle("hidden");
    moresettings.classList.toggle( "collapsed");
    moresettings.classList.toggle("hidden");
});

//generate new ID when clicking icon
generateSessionIcon.addEventListener("click", () => {
    sessionID.value = generateSessionID();
    generateSessionIcon.classList.toggle("rotate360");   //rotate the icon (fancy)
    setTimeout(function () {  generateSessionIcon.classList.toggle("rotate360");  }, 300);
});

//move caret to focus on client id field
document.getElementById("project").focus();

//generate random code and prefil
function generateSessionID(length = 6) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    return Array.from({ length }, () => chars.charAt(Math.floor(Math.random() * chars.length))).join('');
}

sessionID.value = generateSessionID();

//check quality and resolution radio buttons
function getCheckedRadioValue(name) {
    const selected = document.querySelector(`input[name="${name}"]:checked`);
    return selected ? selected.value : null;
}

//check if session id is valid (6 characters long) before prepping session
function checkSessionID() {
    if (!sessionID.value || sessionID.value.length !== 6) {
        sessionID.style.animation = "pulse 300ms";
        setTimeout(() => sessionID.style.animation = "none", 300);
        sessionID.focus();
        return;
    }

    //stuff to run once and once only when starting session 
    storeSelectedDevices(1,0,0)
    setupSessionUI();
    viewerStream();
    setTimeout(function(){   
        startMainStream();
    },1000);
}

//setup UI, change create session to re-use for setting dialog, turn on toolbars create github issue with session id and project name
function setupSessionUI() {
    //encode project name to URI
    const projectName = document.getElementById("project").value || "";
    const sanitizedProject = encodeURIComponent(projectName);

    //encode session ID to URI
    const sessionIDEntered = sessionID.value;
    const sessionIDEnteredUppercase = sessionIDEntered.toUpperCase(); 
    const sessionIDEnteredSanitized = encodeURIComponent(sessionIDEnteredUppercase);

    // Set Session Title & Copy Session Quick Link to Clipboard
    sessionName.innerHTML = projectName + " Live session (" + sessionIDEnteredSanitized + ")";
    navigator.clipboard.writeText("https://alpha.rpxl.app/qv/?" + sessionIDEnteredSanitized );

    //create a new issue on github (used to track sessions) encode session ID
    var sessionAndProject = sessionIDEnteredSanitized+"&"+sanitizedProject
    var encodedSession = btoa(sessionAndProject);

    //console.log("Encoded issue for github Session ID & Client name :", encodedSession );
    //addIssue(encodedSession);  //github.js adds issue to github repo usedd to track sessions

    //hide stream settings creation dialog
    settingsDialog.classList.add("hidden");
    settingsDialog.close();
    document.body.style.backgroundImage = "none";

    //Change create dialog layout for settings to re-use it
    settingsDialog.classList.remove("middle", "top");
    settingsDialog.classList.add("toolpopup", "bottom", "left");
    createHeadingSession.innerHTML = "Session settings";
    settingsDialogProjectID.classList.add("hidden");
    settingsDialogSessionSettings.style.gridTemplateColumns = "105px 200px";
    settingsDialogVideoAudioPreview.classList.add("hidden");
    settingsDialogTitleOptional.classList.remove("collapsed", "hidden");
    createOptional.innerHTML = "User settings";
    moresettings.classList.remove("collapsed", "hidden");
    settingsDialogCameraMicPreview.classList.add("hidden");
    buttonMoreSettings.classList.add("hidden");
    settingsDialogButtons.style.justifyContent = "center";
    startSessionButton.innerHTML = "Change settings";
    startSessionButton.removeEventListener("click", checkSessionID);    // Remove start session listener and add settings change listener

    startSessionButton.addEventListener("click",() => {
        let openModals = document.querySelectorAll("dialog:not(.hidden)");
        openModals.forEach(openModal => {
        openModal.close();
        openModal.classList.add("hidden");
        openIcon.setAttribute("aria-expanded", "false"); 
        openIcon.classList.remove("selected"); 
        document.getElementById("popupBG").classList.add("hidden");
        });

        viewerStream();
        setTimeout(function(){   
            startMainStream();
        },1000);

    });

    mainWindow.classList.remove("hidden");
}
</Script>