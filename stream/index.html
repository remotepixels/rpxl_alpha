<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="-1" />
    <meta name="msapplication-TileColor" content="#2e2e2e" />
    <meta name="description" content="Serverless web app that allows you transmit to a high quality stream to clients to view and comment on using WEBRTC and VDO.NINJA. Communication between clients is handled using low latency and very little bandwidth, dedicating as much bandwidth to the main strea, often the feed from an edit machine. Also, we think Capybara's are awesome though that might not be relevant in this case.">
    <meta name="keywords" content="Gui Felix, Advertising, Visual Effects, Motion Graphics, Remote Pixels, vdo.ninja" />
    <meta name="robots" content="index, follow" />
    <meta name="viewport" content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <link rel="apple-touch-icon" sizes="180x180" href="../icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../icons/favicon-16x16.png">
    <link rel="mask-icon" href="../icons/safari-pinned-tab.svg" color="#5bbad5">
    <link rel="shortcut icon" href="../icons/favicon.ico">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@200" rel="stylesheet" />

    <link rel="stylesheet" href="/styles/styles.css">
    <link rel="stylesheet" href="/styles/streamstyle.css">

    <title>alpha.rpxl.app v3.5 | Stream (beta)</title>
</head>

<body id="body">
    <div class="peerList hidden" id="peerList">
		<div class="peer">
			<video class="peerStream" id="userStream" autoplay playsinline disablepictureinpicture ></video>
			<span id ="userLabel" class="peerLabel"></span>
			<!-- <span class="peerControl"> -->
				<!-- <button  class="peerControlButton"><span class="material-symbols-outlined">mic</span></button> -->
				<!-- <button  class="peerControlButton"><span class="material-symbols-outlined">mode_off_on</span></button> -->
			<!-- </span> -->
		</div>
    </div>
    <div class="mainViewer hidden" id="mainViewer">
   	 	<div class="mainZoom" id="zoomdiv">
		    <video class="mainStream" id="mainStream" autoplay playsinline disablepictureinpicture ></video>
       		<canvas id="markup" class="markup"></canvas>
    	</div>
	</div>

    <!------------------------Main interface------------------>
    <div id="mainWindow" class="hidden ">
        <!--top menu bar-->
        <div id="topmenu" class="toolbar top">
            <div class="toolbar-section left">
                <div class="toolset">
                    <button class="tool moresettings" id="toolShare" aria-expanded="false" role="button"><span class="material-symbols-outlined">ios_share</span></button>
                </div>
            </div>
            <div class="toolbar-section center">
                <div><h2 id="sessionName" class="centervertical">RPXL</h2></div>
            </div>
            <div class="toolbar-section right">
                <div class="toolset">
  					<button class="tool red moresettings" id="toolQuit" aria-expanded="false" role="button"><span class="material-symbols-outlined">mode_off_on</span></button>
                </div>
            </div>
        </div>
        <!--bottom menu bar-->
        <div id="bottomMenu" class="toolbar bottom">
            <div class="toolbar-section left">
                <div class="toolset">
                    <button class="tool moresettings" id="toolSettings" aria-expanded="false" role="button"><span class="material-symbols-outlined">settings</span></button>
                    <button class="tool red disable hidden" aria-expanded="false" id="toolMuteMicrophone" disabled role="button"><span class="material-symbols-outlined">mic</span></button>
                    <button class="tool disable hidden" aria-expanded="false" id="toolMuteCamera" disabled role="button"><span class="material-symbols-outlined">photo_camera</span></button>
                </div>
            </div>
            <div class="toolbar-section center">
				<div class="toolset">
					<button class="tool disable hidden" aria-expanded="false" id="toolFileShare" disabled role="button"><span class="material-symbols-outlined">folder</span></button>
 				</div>

                <div class="toolset">
					<button class="tool red disable hidden " aria-expanded="false" id="toolBlindStream" disabled role="button"><span class="material-symbols-outlined">movie</span></button>
					<button class="tool red disable hidden" aria-expanded="false" id="toolMuteStream" disabled role="button"><span class="material-symbols-outlined">volume_up</span></button>
                    <button class="tool disable hidden spacer" aria-expanded="false" id="toolDraw" disabled role="button"><span class="material-symbols-outlined">format_ink_highlighter</span></button>
                    <button class="tool moresettings disable hidden" aria-expanded="false" id="toolPalette" disabled role="button"><span class="material-symbols-outlined">palette</span></button>
                    <button class="tool disable hidden" aria-expanded="false" id="toolEraser" disabled role="button"><span class="material-symbols-outlined">ink_eraser</span></button>
                    <!-- <button class="tool streamtool disable" aria-expanded="false" id="toolSlideLibrary" disabled role="button"><span class="material-symbols-outlined">slide_library</span></button> -->
                </div>
            </div>
            <div class="toolbar-section right">
                <div class="toolset">
                    <span class="tool volume disable hidden " role="button" id="toolVolume"><input type="range" id="toolStreamVolume" value="0" min="0" max="100" /></span>
                </div>
            </div>
        </div>
        <div class="copyCreditGrad"></div>
        <div class="copyText toolbar-section left" id="statusLeft"></div>
    </div>

    <div class="popupBG hidden" id="popupBG"></div>

    <!--Setup screen, also used as setting panel later-->
    <dialog open id="settingsDialog" class="toolpopup top middle" style="min-width:620px">
        <div class="" id="settingsDialogTitleCreate" style="text-align: left; width:100%;">
            <h2 id="createHeadingSession" style="padding-bottom: 10px;">Create live session</h2><a href="help.html" target="_blank" class="helpicon">
            <span class="material-symbols-outlined">help</span></a>
        </div>
        <div class="tableStream" id="settingsDialogProjectID">
            <div>Project</div>
            <div  style="grid-column: 2 / span 3;">
				<input type="text" class="textinput" maxlenght="40" id="project" name="clientName" placeholder="(Optional)" contenteditable="true">
				<span class="toolset" id="historyButton">
					<button class="tool moresettings" id="toolHistory" aria-expanded="false" role="button">
						<span class="material-symbols-outlined">history</span>
					</button>
				</span>
			</div>
			<!-- <div>Password</div> -->
            <!-- <div><input type="text" class="textinput" maxlenght="40" id="password" name="clientName" placeholder="(Optional)" contenteditable="true"></div> -->
        </div>
        <!-- <div style="width:100%"><hr></div> -->
		<div style="width:100%; margin:10px 0px;"></div>
        <div class="tableStream" id="settingsDialogSessionSettings"">
            <div>Resolution</div>
			<div class="radioset" role="radiogroup" aria-labelledby="resolution" role="button">
				<label><input type="radio" name="resolution" id="res1080P" value="1080" data-width="1920" data-height="1080">1080P</label>
				<label><input type="radio" name="resolution" id="res720P" checked value="720" data-width="1280" data-height="720">720P</label>
			</div>
            <div>Quality</div>
			<div class="radioset" role="radiogroup" aria-labelledby="quality" role="button">
				<label><input type="radio" name="quality" id="qualityHigh" value=16000000 >High</label>
				<label><input type="radio" name="quality" id="qualityMed" value=800000 checked>Med</label>
				<label><input type="radio" name="quality" id="qualityLow" value=4000 >Low</label>
			</div>
            <div>Video source</div><div class="custom-select"><select contenteditable="true" id="videoSource"><option value="">None</option></select></div>
            <div>Audio source</div><div class="custom-select"><select contenteditable="true" id="audioSource"><option value="">None</option></select></div>
			<div style="grid-column: 3; grid-row: 1 / span 4;" id="settingsDialogVideoAudioPreview">
				<video id="video" class="videosource" autoplay playsinline disablepictureinpicture muted></video>
				<span id="meterGraph" class="meterGraph">	<span id="audiometer" class="meter"></span>	</span>
			</div>
        </div>
        <div style="width:100%; margin:10px 0px;"></div>
        <div class="tableStream collapsed" id="moresettings">
            <div style="grid-column: 1 / span 2;"><h2 id="createOptional">Optional user settings</h2></div>
            <div>User</div>
			<div>
				<input type="text" maxlength="25" class="textinput" id="name" name="username" placeholder="Optional (Host)" contenteditable="true" autocomplete="off">
			</div>
            <div>Camera</div>
			<div class="custom-select"><select contenteditable="true" id="cameraSource"><option value="">None</option></select></div>
            <div>Microphone</div>
			<div class="custom-select"><select contenteditable="true" id="microphoneSource"><option value="">None</option></select></div>
            <div id="settingsDialogCameraMicPreview" style="grid-column: 3; grid-row: 1 / span 4;">
				<video id="camera" class="camera" autoplay playsinline disablepictureinpicture muted></video>
				<span id="meterGraph" class="meterGraph">	<span id="micmeter" class="meter"></span>	</span>
			</div>
        </div>
        <div id="moresettingsHR" class="" style="width:100%; margin:10px 0px;"><HR></div>
        <div id="settingsDialogButtons" style="position: relative; width: 100%; display: inline-flex; justify-content: space-between; align-items: center;">
            <div><button id="buttonMoreSettings" class="tool moresettings wider" aria-expanded="false">More setings</button></div>
            <div><button id="startSessionButton" class="botton blue wider">Start session</button></div>
        </div>
    </dialog>

    <!----- history dialog ------>
    <div class="popupBG hidden" id="popupHistoryBG"></div>
    <dialog id="historyDialog" class="toolpopup top right hidden">
    </dialog>

    <!----- share dialog ------>
    <dialog id="shareDialog" class="toolpopup top left share hidden">
        <button class="link" id="copyMainLink"><h2>Main share link</h2><br> Full communication and markup </button>
        <button class="link" id="copyQuickLink"><h2>Quick share link</h2><br> No communications, host can markup<br>Use for faster, no prompt joins</button>
        <!-- <button class="link" id="copyOBSLink"><h2>OBS source link</h2><br> URL for input to OBS browser source </button> -->
       <!-- <button class="link" id="copyOBSLink"><h2>WHIP source link</h2><br> URL for input to FFMPEG<br>Can be used to output to Decklink</button> -->
    </dialog>

    <!----- quit dialog ------>
    <dialog id="quitDialog" class="confirmpopup hidden">
        <button id="confirmQuit" class="button tool red wider"> Confirm quit </button>
    </dialog>

    <!----- color menu ------>
    <dialog id="paletteDialog" class="toolpopup bottom middle hidden">
        <span class="colorpot" role="button" value="black" aria-expanded="false"
            style="background-color: black;"></span><span class="colorpot selectedcolorpot" role="button" value="white"
            aria-expanded="true" style="background-color: white;"></span><span class="colorpot" role="button"
            value="cyan" aria-expanded="false" style="background-color: cyan;"></span><span class="colorpot"
            role="button" value="magenta" aria-expanded="false" style="background-color: magenta;"></span><span
            class="colorpot" role="button" value="yellow" aria-expanded="false"
            style="background-color: yellow;"></span>
    </dialog>

    <!-- mobile browser -->
    <dialog id="mobileDialog" class="toolpopup top middle hidden" style="width:600px!important; top:70px;">
        <span class="material-symbols-outlined" style="font-size:125px">error</span><br>
        <h2>Warning : Mobile browser detected</h2>
        <p>Currently, streaming is desktop only.</p>
        <p>Mobile streaming might work but your mileage may vary. This only affects the streamer, guests can connect via desktop or mobile device.</p>
        <hr>
        <button id="mobileDismiss" class="botton blue wider"> Try anyway </button>
    </dialog>

    <!----- Permissions ------>
    <dialog id="permissionsDialogStream" class="toolpopup top middle hidden" style="width:410px!important;">
        <span class="material-symbols-outlined" style="font-size:125px">error</span><br>
        <h2>Warning : Video or audio permissions blocked</h2>
        <p>Please check your browser settings to allow<br>access to your video and audio sources.</p>
        <p>You will be able to disable them at any time.</p>
        <hr>
        <a href="https://www.google.com/search?q=browser+miicrophone+and+camera+permissions+setup+for+desktop+and+mobile&rlz=1C5CHFA_enCH1148CH1149&oq=browser+miicrophone+and+camera+permissions+setup+for+desktop+and+mobile&gs_lcrp=EgZjaHJvbWUyBggAEEUYOdIBCTIxMDk0ajBqN6gCCLACAfEFhqUbtfZyAjs&sourceid=chrome&ie=UTF-8" target="_new"><button id="permissionMicHelp" class="botton buttonblue buttonWider"> Click here for more info</button></a>
    </dialog>

	<div id="bannerStack" aria-live="polite"></div>

	<template id="bannerTemplate">
   		<div class="banner">
			<span>	</span>
    	</div>
	</template>

    <!----- popup stream zoomed popup------>
    <div id="zoom-popup" class="zoom-popup">Stream zoomed</div>

</body>
</html>

<script src="/scripts/vdoninja-sdk.js"></script>
<script src="/scripts/storage.js"></script>
<script src="/scripts/global.js"></script>
<script src="/scripts/initdevice.js"></script>
<script src="/scripts/initstreams.js"></script>
<script src="/scripts/initvdo.js"></script>
<script src="/scripts/listeners.js"></script>
<script src="/scripts/interface.js"></script>
<script src="/scripts/markup.js"></script>

<script type="text/javascript">
	sessionStorage.clear(); //clear session storage on load to avoid issues with old settings
	sessionStorage.setItem("sessionID", generateRandomID());  //create session ID and store in session storage

	const APP_NS = 'host-Alpha-RPXL';
	const devURL = window.location.origin;
	let historyBGAttached = false;
	let isVDOReady = false;
	let mainPublished = false;

	randomBG(); //random background image from interface.js
	restoreSetingsLast(); //restore last used settings from local storage
	
	//check if mobile device and warn user
	const mobileDialog = document.getElementById("mobileDialog");
	const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

	if (isMobile) {
		mobileDialog.classList.remove("hidden");
		mobileDialog.show();
		mobileDismiss.addEventListener("pointerdown", () => {
			mobileDialog.classList.add("hidden");
			mobileDialog.close();
		});
		//console.log("User is on a mobile device.");
	}

	//pretty date in history dialog
	function formatDateISO(dateString) {
		const d = new Date(dateString);
		return (
			d.getFullYear() + "-" +
			String(d.getMonth() + 1).padStart(2, "0") + "-" +
			String(d.getDate()).padStart(2, "0") + " " +
			String(d.getHours()).padStart(2, "0") + ":" +
			String(d.getMinutes()).padStart(2, "0")
		);
	}

	//create session history drop down
	function loadHistoryIntoDialog() {
		const sessionsJSON = localStorage.getItem(APP_NS);
		if (!sessionsJSON) return;

		const sessions = JSON.parse(sessionsJSON);
		const dialog = document.getElementById("historyDialog");

		openDialog(historyDialog, toolHistory);
		document.getElementById("popupHistoryBG").classList.remove("hidden");

		// Attach background listener ONCE
		if (!historyBGAttached) {
			window.addEventListener("pointerdown", (e) => {
				if (e.target.matches("#popupHistoryBG")) {
					closeDialog(openModal, openIcon);
					document.getElementById("popupHistoryBG").classList.add("hidden");
				}
			});
			historyBGAttached = true;
		}

		dialog.innerHTML = `
        <span class="historyHeader">IMPORTANT: Loading a previous session will also re-use existing link(s)</span><br>
        <hr>`; // reset

		sessions.forEach(entry => {
			const project = decodeURIComponent(entry.projectName) || "Unnamed project";
			const formattedDate = formatDateISO(entry.createdAt);

			const btn = document.createElement("button");
			btn.className = "link historyEntry";
			btn.dataset.sessionId = entry.sessionID;

			btn.innerHTML = `
            <h2>${project}</h2>
            <span class="date">${formattedDate}</span>
        `;

			btn.addEventListener("click", async () => {
				restoreSessionFromHistory(entry);
				//console.log(`Restored session from history: ${entry.sessionID}`);
			});

			dialog.appendChild(btn);
		});
	}
	//restore session ID and session name from history entry selected
	async function restoreSessionFromHistory(entry) {
		// Restore sessionID + projectName only here
		sessionStorage.setItem("sessionID", entry.sessionID);
		console.log(`Restored sessionID: ${entry.sessionID} from history`);

		const projectInput = document.getElementById("project");
		projectInput.value = decodeURIComponent(entry.projectName) === "Unnamed project"
			? ""
			: decodeURIComponent(entry.projectName);

		// Restore all *other* UI settings
		await restoreSettingsHost(entry); //from initui.js
		await handleSelectionChange(); // single attach
		closeDialog(openModal, openIcon);
		document.getElementById("popupHistoryBG").classList.add("hidden");
	}
	//restore last used settings from local storage on load
	async function restoreSetingsLast() {
		document.getElementById("project").value = ""; //clear project name on load
		await getDevices();        // enumerate only / or release probes
		[mainAudioSelect, userAudioSelect, mainVideoSelect, userVideoSelect]
			.forEach(sel => sel.addEventListener('change', scheduleSelectionChange));
		await handleSelectionChange(); // single attach

		const sessionsJSON = localStorage.getItem(APP_NS);
		if (!sessionsJSON) return;

		const sessions = JSON.parse(sessionsJSON);
		if (!sessions.length) return;

		const last = sessions[0];

		restoreSettingsHost(last); // UI only
		await handleSelectionChange(); // single attach
	}

	//more settings menu on create dialogue flyout
	buttonMoreSettings.addEventListener("pointerdown", () => {
		const isExpanded = buttonMoreSettings.getAttribute("aria-expanded") === "true";
		buttonMoreSettings.setAttribute("aria-expanded", isExpanded ? "false" : "true");
		buttonMoreSettings.innerHTML = isExpanded ? "More settings" : "Less settings";
		document.getElementById("moresettings").classList.toggle("collapsed");
	});

	document.getElementById('startSessionButton').addEventListener('pointerdown', startSession);

	//share button (main, quick and obs)
	function setupShareButton(buttonId, sessionID, urlFormatter) {
		const btn = document.getElementById(buttonId);
		if (!btn) return;

		btn.addEventListener("pointerdown", () => {
			const value = sessionStorage.getItem(sessionID);
			if (!value) return;

			const url = urlFormatter(value);
			//console.log(`Copying to clipboard: ${url}`);
			navigator.clipboard.writeText(url).then(() => {
				closeDialog(shareDialog, toolShare);    //close share dialog
				showBanner({ message:"Link copied to clipboard", type:"notification", timeout:3000 });
			});
		});
	}

	setupShareButton("copyMainLink", "sessionID", value => `${devURL}/?SID=${value}`);
	setupShareButton("copyQuickLink", "sessionID", value => `${devURL}/qv/?SID=${value}`);
	setupShareButton("copyOBSLink", "sessionID", value => `${devURL}/vdo/?view=Stream${value}&solo&room=RPXL${value}`);

	confirmQuit.addEventListener("pointerdown", function () {
		vdo.disconnect();
		vdoMS.disconnect()

		document.getElementById("mainStream").src = "";
		document.getElementById("userStream").src = "";

		location.reload();
	});

	async function startSession() {
		//stuff to run once and once only when starting session
		const sessionID = sessionStorage.getItem("sessionID");
		const timestamp = new Date().toISOString();
		const sanitizedProject = encodeURIComponent(document.getElementById("project").value.trim());
		const resolution = getCheckedRadioValue("resolution"); //from initui.js
		const quality = getCheckedRadioValue("quality"); //from initui.js
		const videoSource = document.getElementById("videoSource").selectedOptions[0].value;
		const audioSource = document.getElementById("audioSource").selectedOptions[0].value;
		const sanitizedUserName = encodeURIComponent(document.getElementById("name").value.trim()) || "";
		const cameraSource = document.getElementById("cameraSource").selectedOptions[0].value;
		const microphoneSource = document.getElementById("microphoneSource").selectedOptions[0].value;

		const entry = {
			sessionID: sessionID || "",
			createdAt: timestamp || "",
			projectName: sanitizedProject || "",
			resolution: resolution || "",
			quality: quality || "",
			videoSource: videoSource || "",
			audioSource: audioSource || "",
			userName: sanitizedUserName || "",
			cameraSource: cameraSource || "",
			microphoneSource: microphoneSource || ""
		};

		const sessionsJSON = localStorage.getItem(APP_NS);
		let sessions = sessionsJSON ? JSON.parse(sessionsJSON) : [];

		sessions.unshift(entry);
		sessions = sessions.slice(0, 5);

		localStorage.setItem(APP_NS, JSON.stringify(sessions)); //store session settings in local storage for history

		navigator.clipboard.writeText(`${devURL}/?SID=${sessionID}`);  

		//hide stream settings creation dialog
		sessionName.innerHTML = decodeURIComponent(sanitizedProject);
		settingsDialog.close();
		document.body.style.backgroundImage = "none";

		//remove any previews
		 video.srcObject = null;
		 camera.srcObject = null;

		//Change create dialog layout for settings to re-use it
		["settingsDialog", "historyButton", "buttonMoreSettings", "settingsDialogCameraMicPreview", "settingsDialogVideoAudioPreview"].forEach(id => {
			document.getElementById(id).classList.add("hidden");
		});
		// settingsDialogProjectID.style.width = "200px";
		project.style.width = "200px";
		project.style.left = "5px";
		moresettingsHR.classList.remove("hidden");
		settingsDialog.classList.remove("middle", "top", "min-width");
		settingsDialog.style.minWidth = "fit-content";
		settingsDialog.classList.add("toolpopup", "bottom", "left");
		createHeadingSession.innerHTML = "Session settings";
		settingsDialogSessionSettings.style.gridTemplateColumns = "110px 200px";
		createOptional.innerHTML = "User settings";
		moresettings.classList.remove("collapsed", "hidden");
		settingsDialogButtons.style.justifyContent = "center";
		startSessionButton.innerHTML = "Change settings";
		moresettings.classList.add("hideTableColumn");
		settingsDialogSessionSettings.classList.add("hideTableColumn");

		startSessionButton.removeEventListener("pointerdown", startSession);    // Remove start session listener and add settings change listener

		window.addEventListener("wheel", onWheel, { passive: false });
		window.addEventListener("pointerdown", onMouseDown);
		window.addEventListener("pointermove", onMouseMove);
		window.addEventListener("pointerup", onMouseUp);

		startSessionButton.addEventListener("pointerdown", () => {
			initUserStream();//from initvdo.js
		});

		["mainWindow", "peerList", "mainViewer"].forEach(id => {
			document.getElementById(id).classList.remove("hidden");
		});

		VDOConnect(sessionID);
	}
</Script>